let gridOptions,PASAJEROS="";function asignarEventos(){$(".contenedor-altas").hide(),$(".costeo-relacion").hide(),$(".btn-pdf").hide(),$("#btnServicio").hide(),$("#myGrid2").addClass("event-none"),$(".aeroSearch").hide(),$(".emprSearch").hide(),$(".cliSearch").hide(),aplicarMascaraCantidad("subtotal","ivaNac","ivaInt","total","cant_pernocta","tot_pernocta","cant_hrs","tot_hrs"),document.addEventListener("keydown",a=>{"Escape"===a.key&&resetForm()}),document.getElementById("aeronave_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".aeroSearch").show(),$(".inAeroSrch").focus();let e=await obtenerAeronaves();const t=await mostrarListaSearch(e,".aeroSearch","aeronave_id","modelo");t&&(PASAJEROS=t.asientos,activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]}))})),document.getElementById("slctOpcion").addEventListener("change",(async function(a){mostrarClienteEmpresa()})),document.getElementById("cliente_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".cliSearch").show(),$(".inCliSrch").focus();let e=await obtenerClientes();await mostrarListaSearch(e,".cliSearch","cliente_id","nombre")&&(activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]}))})),document.getElementById("broker_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".emprSearch").show(),$(".inEmprSrch").focus();let e=await obtenerEmpresas();const t=await mostrarListaSearch(e,".emprSearch","broker_id","nombre");t&&(activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]})),$("#rt-responsable").val(t.contacto_principal)}));const a=document.querySelector(".toggle-pax"),e=document.querySelector(".toggle-pax-cont");a.addEventListener("click",(function(){e.classList.contains("expanded")?(e.classList.remove("expanded"),a.classList.remove("expanded")):(e.classList.add("expanded"),a.classList.add("expanded"))}));const t=document.querySelector(".toggle-relRuta"),o=document.querySelector(".toggle-relRuta-cont");t.addEventListener("click",(async function(){o.classList.contains("expanded")?(o.classList.remove("expanded"),t.classList.remove("expanded"),$("#formRelRuta").empty()):(o.classList.add("expanded"),t.classList.add("expanded"))}));const r=document.querySelector(".toggle-relRuta");r.addEventListener("mousedown",(async function(){await relRutasPax(r)}))}function configurarBotones(){$("#crear-solCot").click(mostrarContenedorAltas),$("#btnCancel").click(a=>{resetForm()}),$("#actTipoCambio").click(async a=>{await obtenerTipoCambio()&&SwalToast("success","Tipo de Cambio Actualizado.",2500)}),$("#btnPasajero").click(a=>{nuevoPax()}),$("#btnGuardar").click(async a=>{const e=validateInputs($("#formAltas")),t=$("#estatus").val();if(e&&(""==t||"PND"==t||"CTZ"==t))if($("#cotizar_id").val()){document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]")?(await actualizarCotizacion(),await actualizarRutaPax()):await actualizarCotizacion()}else await crearCotizacion()}),$("#genera_pdf").click(a=>{$("#cotizar_id").val()&&obtenerCotizacionPDF()}),$("#btnServicio").click(a=>{$("#cotizar_id").val()&&generarServicio()})}function inicializarPagina(){iniciarTabla("",[{headerName:"id",field:"cotizar_id",width:80},{headerName:"Folio",field:"folio_cotizar",width:80},{headerName:"Broker",field:"nombreBrok",width:110},{headerName:"Cliente",field:"nombreCli",width:110},{headerName:"Aeronave",field:"modeloAeronave",width:160},{headerName:"Ruta",field:"concepto",width:180},{headerName:"Fecha Salida",field:"fecha_salida",width:100},{headerName:"Total",field:"total",width:120,cellStyle:{textAlign:"right"},valueFormatter:function(a){return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Estatus",field:"estatus",width:80},{headerName:"Acción",cellRenderer:function(a){const e=document.createElement("I");e.className="fa-regular fa-pen-to-square btn btn-editar",e.title="Ver o Editar",e.addEventListener("click",(async function(e){if(0==Object.keys(a.data).length)return;$("#aeronave_id").prop("disabled",!0),$("#slctOpcion").prop("disabled",!0),$("#cliente_id").prop("disabled",!0),$("#broker_id").prop("disabled",!0),$("#cotizar_id").val(a.data.cotizar_id),$("#folio").val(a.data.folio_cotizar),$("#fecha-cot").val(formatearFecha(a.data.fecha_creacion)),$("#rt-comment").val(a.data.comentarios),$("#estatus").val(a.data.estatus),$("#aeronave_id option").val(a.data.aeronave_id),$("#aeronave_id option").text(a.data.modeloAeronave),$("#tipo_cambio option").val(a.data.tipo_cambio_id),$("#tipo_cambio option").text(Number(a.data.tipo_cambio).toFixed(2)),await mostrarContenedorAltas(),a.data.cliente_id?($("#slctOpcion").val(1),mostrarClienteEmpresa(),$("#cliente_id option").val(a.data.cliente_id),$("#cliente_id option").text(a.data.nombreCli)):a.data.broker_id&&($("#slctOpcion").val(2),mostrarClienteEmpresa(),$("#broker_id option").val(a.data.broker_id),$("#broker_id option").text(a.data.nombreBrok),$("#rt-responsable").val(a.data.contacto_principal)),botonPdfCotizar();let t=(await obtnerVuelosId(a.data.cotizar_id)).map(a=>{let e={cot_det_id:a.cot_det_id,fecha_salida:a.fecha_salida,hora_salida:a.hora_salida,categoria:{categoria_id:a.categoria_id,nombre:a.nombreCat},concepto:a.concepto,pasajeros:a.pasajeros,tipo_vuelo:a.tipo_vuelo,cantidad:a.cantidad,percost:a.percost,tarifa:a.tarifa,subtotal:a.subtotal,rel_ruta:a.rel_ruta,relaciones_id:a.relacion_id,line_id:a.line_id};return 1==a.categoria_id&&(e.origen={aeropuerto_id:a.origenId,municipio:a.origMun},e.destino={aeropuerto_id:a.destinoId,municipio:a.destMun}),e});if(console.log(t),t.length<9){const a=Array(8-t.length).fill({}),e=t.concat(a).map(a=>({...a}));gridApi.setGridOption("rowData",e)}else gridApi.setGridOption("rowData",t);actTotales(),activarRutas();let o=await obtenerPax(a.data.cotizar_id);for(let a=0;a<o.length;a++)nuevoPax();const r=document.querySelectorAll("#formPasajeros .cont-pasajero");r.length==o.length&&r.forEach((a,e)=>{const t=o[e].pasajero_id,r=o[e].nombre,i=a.querySelector("#paxName"+(e+1));i.value=r,i.dataset.pax=t}),await ordenarPorCategoria(),$(".costeo-relacion").show()}));const t=document.createElement("div");return t.classList="btn-cont centrado",t.appendChild(e),$(".pasajeros").prop("disabled",!1),t},width:150,headerClass:"txt-center",cellClass:"custom-action-cell",filter:!1}],"#myGrid"),obtenerCotizaciones()}async function configTablaCrear(){mostrarClienteEmpresa();let a=await obtenerAeropuertos(),e=await obtenerCategorias(),t=await obtenerProductos(),o=[{headerName:"Id",field:"cot_det_id",width:60},{headerName:"",headerGroupComponent:CustomHeaderGroup,children:[{headerName:"Fecha",field:"fecha_salida",width:80,cellEditor:"agDateCellEditor",editable:!0,valueFormatter:function(a){let e=a.value;return e?formatearFecha(e):null},cellClassRules:{"event-none":a=>{}}},{headerName:"Hora",field:"hora_salida",width:120,editable:!0,columnGroupShow:"open",valueFormatter:function(a){if(null!==a.value&&void 0!==a.value){const e=a.value;let t=0,o=0;if(e)if(e.includes(":")){const a=e.split(":");t=a[0],o=a[1]}else t=e;else t=e;const r=parseFloat(t),i=parseFloat(o),n=`${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`;return/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/.test(n)?n:"00:00"}return null}}]},{headerName:"Cat",field:"categoria",width:80,cellEditor:"agSelectCellEditor",editable:!1,cellEditorParams:{values:["",...e.map(a=>({categoria_id:a.categoria_id,nombre:a.nombre}))]},valueFormatter:function(a){if(a.value)return a.value.nombre},valueGetter:function(a){return a.data.categoria},valueSetter:function(a){return a.data.categoria=a.newValue,!0},cellClassRules:{"event-none":a=>{const e=a.data.cot_det_id;return null!=e&&""!==e}}},{headerName:"Concepto",field:"concepto",width:180,editable:!1},{headerName:"Origen",field:"origen",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...a.map(a=>({aeropuerto_id:a.aeropuerto_id,municipio:a.municipio}))]},valueFormatter:function(a){if(a.value)return a.value.municipio},valueGetter:function(a){return a.data.origen},valueSetter:function(a){return a.data.origen=a.newValue,!0}},{headerName:"Destino",field:"destino",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...a.map(a=>({aeropuerto_id:a.aeropuerto_id,municipio:a.municipio}))]},valueFormatter:function(a){if(a.value)return a.value.municipio},valueParser:function(a){if(a.value)return{aeropuerto_id:a.value.aeropuerto_id,municipio:a.value.municipio}},cellClassRules:{"event-none":a=>{const e=a.data.cot_det_id;return null!=e&&""!==e}}},{headerName:"Pax",field:"pasajeros",width:60,editable:!0,cellEditor:"agNumberCellEditor",valueParser:function(a){return parseFloat(a.newValue)||null},valueFormatter:function(a){return null!==a.value&&void 0!==a.value?Math.round(a.value):null}},{headerName:"Tipo",field:"tipo_vuelo",width:80,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["N","I"]},valueFormatter:function(a){const e=a.value;return"I"===e?"Internacional":"N"===e?"Nacional":e},editable:!1},{headerName:"",headerGroupComponent:CustomHeaderGroup,children:[{headerName:"Cant",field:"cantidad",width:80,cellEditor:"agNumberCellEditor",editable:!0,valueParser:function(a){return parseFloat(a.newValue)||null},valueFormatter:function(a){return"number"!=typeof a.value||isNaN(a.value)?null:a.value.toFixed(1)}},{headerName:"Pernocta Costo",field:"percost",width:80,cellEditor:"agNumberCellEditor",editable:!0,columnGroupShow:"open",valueParser:function(a){return"0"==a.newValue?.5:parseFloat(a.newValue)||null},valueFormatter:function(a){return"number"!=typeof a.value||isNaN(a.value)?null:a.value.toFixed(1)}}]},{headerName:"Tarifa",field:"tarifa",width:100,editable:!0,cellEditor:"agNumberCellEditor",valueFormatter:function(a){if(a.value)return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Subtotal",field:"subtotal",width:100,cellStyle:{textAlign:"right"},valueFormatter:function(a){if(a.value)return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Relacion Ruta",field:"rel_ruta",width:80},{headerName:"Relacion",field:"relaciones_id",width:80},{headerName:"LineID",field:"line_id",width:80},{headerName:"Acción",width:90,cellRenderer:function(a){const e=$("#estatus").val();if(("PND"==e||"CTZ"==e||""==e)&&a.data.categoria&&a.data.categoria.nombre){const e=document.createElement("I");e.className="fa-regular fa-trash-can btn btn-eliminar",e.title="Eliminar",e.addEventListener("click",(async function(){if(0==Object.keys(a.data).length)return;const e=a.data.line_id,t=a.node;e?(await validarDetEliminar(e,t),actTotales(),actualizarCotizacion()):limpiarCelda(t)}));const t=document.createElement("div");return t.classList="btn-cont centrado",t.appendChild(e),t}},headerClass:"txt-center",cellClass:"custom-action-cell",filter:!1}];iniciarTabla("",o,"#myGrid2"),$("#cotizar_id").val()||await obtenerTipoCambio(),establecerAsientos(),gridApi.addEventListener("cellValueChanged",(async function(a){const e=a.column.colId,t=a.node.data,o=a.rowIndex;let r=t.origen?t.origen.aeropuerto_id:"",i=t.destino?t.destino.aeropuerto_id:"";if("origen"==e||"destino"==e){if($("#aeronave_id").val()){if(r&&i){let a=await validaRutaTarifa(r,i);if("0"==a.exito){SwalToast("warning",a.alertas.error[0],2500);let e=gridApi.getRowNode(o);e&&e.data&&Object.keys(e.data).forEach(a=>{e.setDataValue(a,null)})}else{$("#costo_id").val(a.tarifa.costo_id),"N"==a.ruta.tipo_vuelo?t.tarifa=a.tarifa.costo_mx:"I"==a.ruta.tipo_vuelo&&(t.tarifa=a.tarifa.costo_usd),t.tipo_vuelo=a.ruta.tipo_vuelo,t.relaciones_id=a.ruta.ruta_id,t.rel_ruta=a.ruta.ruta_id,t.hora_salida="00:00",t.cantidad="1";let e="";"Ruta"==t.categoria.nombre&&(e=await obtenerCodigosIATA(r,i),t.concepto=e);let o=await consecutivoLineID();t.line_id=o,gridApi.applyTransaction({update:[t]}),await generarPernoctas(),await generarAterrizajes(),await generarTUA(),await ordenarPorCategoria(),gridApi.applyTransaction({update:[t]})}}}else SwalToast("warning","Selecciona una Aeronave",2500)}if("fecha_salida"==e&&r&&i&&(console.log("generar"),await generarPernoctas(),await ordenarPorCategoria()),"pasajeros"==e){const e=a.newValue,o=a.oldValue;if(e>PASAJEROS&&(t.pasajeros=PASAJEROS,gridApi.applyTransaction({update:[t]})),t.origen&&t.destino){const a=[];if(gridApi.forEachNode(e=>{const t=e.data;t.categoria&&"Ruta"===t.categoria.nombre&&t.origen&&t.destino&&a.push(t)}),a.length>0){await obtenerAeropuertos();for(let r=0;r<a.length;r++){const i=a[r].origen.aeropuerto_id;let n=0;if(gridApi.forEachNode(a=>{a.data.categoria&&"Tua"===a.data.categoria.nombre&&a.data.relaciones_id===i&&n++}),e<=n)return t.pasajeros=o,gridApi.applyTransaction({update:[t]}),void SwalToast("warning","El número de TUAS existentes es suficiente",2500)}}await generarTUA(),await ordenarPorCategoria()}}t.origen&&t.destino&&(actTotalesLine(t),actTotales()),t.percost&&t.categoria&&(actTotalesLine(t),actTotales()),t.categoria&&t.tarifa&&(actTotalesLine(t),actTotales())})),gridApi.addEventListener("cellDoubleClicked",(async function(o){const r=o.column.colId,i=o.node.data,n=o.rowIndex,d=o.event.target;if("categoria"==r){const a=e.map(a=>({id:a.categoria_id,nombre:a.nombre}));let t=await mostrarListaGrid(d,a,"#filtro",".contenedor-altas"),o=gridApi.getRowNode(n);i.categoria&&limpiarCelda(o),o=gridApi.getRowNode(n);const r={categoria_id:t.id,nombre:t.nombre};o.setDataValue("categoria",r),gridApi.redrawRows()}if("concepto"==r&&i.categoria){if("Producto"==i.categoria.nombre){const a=t.map(a=>({id:a.producto_id,nombre:a.nombre}));let e=await mostrarListaGrid(d,a,"#filtro",".contenedor-altas"),o=await consecutivoLineID();const r=gridApi.getRowNode(n),i=t.find(a=>a.producto_id===e.id);r.setDataValue("concepto",e.nombre),r.setDataValue("relaciones_id",e.id),r.setDataValue("tarifa",i.precio),r.setDataValue("cantidad","1"),r.setDataValue("line_id",o),gridApi.redrawRows()}i.categoria.nombre,i.categoria.nombre,i.categoria.nombre}if("origen"===r||"destino"===r){const e=a.map(a=>({id:a.aeropuerto_id,nombre:a.municipio}));if(i.categoria&&"Ruta"==i.categoria.nombre&&(!i||!i.cot_det_id)){let a=await mostrarListaGrid(d,e,"#filtro",".contenedor-altas");const t=gridApi.getRowNode(n),o={aeropuerto_id:a.id,municipio:a.nombre};"origen"===r?t.setDataValue("origen",o):t.setDataValue("destino",o),gridApi.redrawRows()}}}))}function limpiarCelda(a){const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)});e.forEach(a=>{a.colId}),a.setData({})}function actTotalesLine(a){if(!a)return;const e=a.categoria.nombre,t=parseFloat(a.cantidad||0),o=parseFloat(a.tarifa||0),r=parseFloat(a.percost||.5);let i=0;"Ruta"==e?(i=t*o,a.subtotal=i):"Pernocta"==e?(i=t*r*o,a.subtotal=i):"Aterrizaje"==e?(i=o,a.subtotal=i):"Producto"==e&&(i=t*o,a.subtotal=i),gridApi.applyTransaction({update:[a]})}function actTotales(){let a=0,e=0,t=0,o=0,r=0,i=0,n=0,d=0,c=0;gridApi.forEachNode(d=>{const c=parseFloat(d.data.cantidad||0),l=parseFloat(d.data.subtotal||0);d.data.categoria&&"Pernocta"==d.data.categoria.nombre&&(a+=c,e+=l),d.data.categoria&&"Ruta"==d.data.categoria.nombre&&(t+=c,o+=l),r+=l,"N"==d.data.tipo_vuelo?i+=l:"I"==d.data.tipo_vuelo&&(n+=l)}),d=.16*i,c=.04*n,$("#cant_pernocta").val(a),$("#tot_pernocta").val(e),$("#cant_hrs").val(t),$("#tot_hrs").val(o),$("#subtotal").val(r),$("#ivaNac").val(d),$("#ivaInt").val(c),$("#total").val(r+d+c)}function mostrarClienteEmpresa(){let a=$("#slctOpcion").val();1==a?($("#inpCliente").show(),$("#inpEmpresa").hide(),$("label[for='cliente_id']").addClass("labelImportant"),$("label[for='broker_id']").removeClass("labelImportant"),$("select[id='broker_id'] option").val(""),$("select[id='broker_id'] option").text("")):2==a&&($("#inpCliente").hide(),$("#inpEmpresa").show(),$("label[for='broker_id']").addClass("labelImportant"),$("label[for='cliente_id']").removeClass("labelImportant"),$("select[id='cliente_id'] option").val(""),$("select[id='cliente_id'] option").text(""))}function activarRutas(){let a=$("#aeronave_id").val(),e=$("#cliente_id").val(),t=$("#broker_id").val(),o=$("#estatus").val();("PND"==o||"CTZ"==o||""==o)&&""!==a&&(""!==e||""!==t)?($("#myGrid2").removeClass("event-none"),$("#formTotales").removeClass("event-none"),$("#formPasajeros").removeClass("event-none")):($("#myGrid2").addClass("event-none"),$("#formTotales").addClass("event-none"),$("#formPasajeros").addClass("event-none"))}async function ordenarPorCategoria(){const a=[],e=[],t=[],o=[],r=[];gridApi.forEachNode(i=>{const n=i.data;a.push(n),n.categoria&&("Ruta"==n.categoria.nombre?e.push(n):n.categoria&&"Pernocta"==n.categoria.nombre?o.push(n):n.categoria&&"Aterrizaje"==n.categoria.nombre?t.push(n):r.push(n))});let i=[...e,...o,...t,...r];i.push({}),gridApi.updateGridOptions({rowData:i})}async function generarPernoctas(){const a=[];if(gridApi.forEachNode(e=>{e.data.categoria&&"Pernocta"===e.data.categoria.nombre&&!e.data.cot_det_id&&a.push(e.data)}),a.length>0){gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)}),gridApi.updateGridOptions({rowData:e})}const e=[],t={};if(gridApi.forEachNode(a=>{const o=a.data;o.categoria&&"Ruta"===o.categoria.nombre&&o.origen&&o.destino?e.push(o):o.categoria&&"Pernocta"===o.categoria.nombre&&(t[o.relaciones_id]=o)}),e.length>1){const a=[];let o=await consecutivoLineID();for(let r=0;r<e.length-1;r++){const i=new Date(e[r].fecha_salida),n=i.getDate(),d=e[r].concepto,c=e[r].tarifa,l=e[r].relaciones_id,s=e[r].line_id,p=new Date(e[r+1].fecha_salida).getTime()-i.getTime(),u=Math.floor(p/864e5);if(u>0)if(t[l])t[l].cantidad=u,t[l].subtotal=.5*u*c;else{console.log("lineID"),console.log(s);const e={cot_det_id:"",hora_salida:"0",categoria:{categoria_id:2,nombre:"Pernocta"},concepto:`${d} - Día: ${n}`,origen:"",destino:"",pasajeros:"",tipo_vuelo:"",cantidad:u,tarifa:c,percost:"0.5",subtotal:.5*u*c,rel_ruta:s,line_id:o};o++,a.push(e)}}a.length>0&&gridApi.applyTransaction({add:a});const r=Object.values(t).filter(a=>void 0!==a.cantidad);r.length>0&&gridApi.applyTransaction({update:r})}}async function generarAterrizajes(){const a=[];if(gridApi.forEachNode(e=>{e.data.categoria&&"Aterrizaje"==e.data.categoria.nombre&&a.push(e.data)}),a.length>0){gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)}),gridApi.updateGridOptions({rowData:e})}const e=[];gridApi.forEachNode(a=>{const t=a.data;t.categoria&&"Ruta"===t.categoria.nombre&&e.push(t)});let t=await consecutivoLineID();if(e.length>0){const a=[],o=$("#aeronave_id").val();for(i in e){const r=e[i].destino.aeropuerto_id,n=e[i].concepto,d=e[i].line_id;console.log(d);const c=await obtenerTasaAterrizaje(r,o);if(1==c.exito){const e={cot_det_id:"",hora_salida:"0",categoria:{categoria_id:3,nombre:"Aterrizaje"},concepto:n,origen:"",destino:"",pax:"",tipo_vuelo:"",tarifa:c.aterrizaje.tarifa_aterrizaje,subtotal:c.aterrizaje.tarifa_aterrizaje,relaciones_id:c.aterrizaje.tasa_aterrizaje_id,rel_ruta:d,line_id:t};t++,a.push(e)}}a.length>0&&gridApi.applyTransaction({add:a})}}async function generarTUA(){const a=[];gridApi.forEachNode(e=>{e.data.categoria&&"Tua"===e.data.categoria.nombre&&!e.data.cot_det_id&&a.push(e.data)}),a.length>0&&gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;t.categoria&&"Ruta"===t.categoria.nombre&&t.origen&&t.destino&&e.push(t)});let t=await consecutivoLineID();const o=[];if(e.length>0){const a=await obtenerAeropuertos();for(let r=0;r<e.length;r++){const i=e[r].origen.aeropuerto_id,n=e[r].pasajeros,d=e[r].line_id,c=a.find(a=>a.aeropuerto_id==i);if(c&&c.costo_tua){const a="TUA - "+c.codigo_iata;let e=0;gridApi.forEachNode(a=>{a.data.categoria&&"Tua"===a.data.categoria.nombre&&a.data.relaciones_id===i&&e++});const r=n-e;if(r>0)for(let e=0;e<r;e++){const e={line_id:t,cot_det_id:"",hora_salida:"0",categoria:{categoria_id:5,nombre:"Tua"},concepto:a,origen:"",destino:"",pax:"",tipo_vuelo:"",tarifa:c.costo_tua,subtotal:c.costo_tua,rel_ruta:d,relaciones_id:c.aeropuerto_id};t++,o.push(e)}}}o.length>0&&gridApi.applyTransaction({add:o})}}function resetForm(){resetearTabla("#myGrid2","#searchInput1"),cerrarVentana(".contenedor-altas",["#formAltas","#formTotales"]),$("#inpCliente").hide(),$("#inpEmpresa").hide(),$("#inpGeneral").hide(),$("#aeronave_id").prop("disabled",!1),$("#slctOpcion").prop("disabled",!1),$("#cliente_id").prop("disabled",!1),$("#broker_id").prop("disabled",!1);const a=document.querySelectorAll("#formPasajeros .cont-pasajero");for(let e=0;e<a.length;e++)a[e].remove();$("#formRelRuta").empty(),botonPdfCotizar(),PASAJEROS="",MAXPAX=0,limpiarForm("#formAltas"),obtenerCotizaciones()}async function mostrarContenedorAltas(){await configTablaCrear(),setFechaActual("fecha-cot"),$(".contenedor-altas").show()}function botonPdfCotizar(){$(".btn-pdf").toggle(["CTZ","SVC","CMP"].includes($("#estatus").val())),$("#btnServicio").toggle("CTZ"===$("#estatus").val())}function nuevoPax(){const a=document.getElementById("formPasajeros"),e=document.getElementById("btnPasajero");let t=a.querySelectorAll(".cont-pasajero").length+1;const o=document.createElement("DIV");o.classList.add("cont-form2","cont-pasajero");const r=document.createElement("DIV");r.classList.add("form-group");const i=document.createElement("INPUT");i.type="text",i.id="pasajero_id"+t,i.classList.add("hidden");const n=document.createElement("INPUT");n.type="text",n.id="paxName"+t,n.placeholder="",r.appendChild(n);const d=document.createElement("LABEL");d.textContent="Pasajero "+t+":",d.htmlFor="paxName"+t,r.appendChild(d),o.appendChild(r);const c=document.createElement("DIV");c.classList.add("form-group");const l=document.createElement("INPUT");l.type="file",l.name="paxFile"+t,l.id="paxFile"+t,l.accept="image/*",c.appendChild(l);const s=document.createElement("A");s.id="btnEliminarPax"+t,s.classList.add("btn","btn-eliminarPax"),s.title="Eliminar Pasajero",c.appendChild(s),o.appendChild(c),a.insertBefore(o,e),$("#btnEliminarPax"+t).on("click",(async function(){const a=$("#cotizar_id").val(),e=$(this).closest(".cont-pasajero").find('input[id^="paxName"]').data("pax");a&&e&&await eliminarPasajero(a,e),$(this).closest(".cont-pasajero").remove()}))}async function obtenerPax(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/pax",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerRutPaxCot(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/rutPaxCot",{method:"POST",body:e}),o=await t.json();return console.log(o),o}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function validarGrid(){let a=[];try{gridApi.forEachNode(e=>{const t=e.data.relaciones_id,o=e.data.categoria,r=e.data.concepto,i=e.data.fecha_salida,n=e.data.cantidad;let d={};if(t){if(d={...e.data},d.categoria&&void 0!==d.categoria.categoria_id&&(d.categoria=d.categoria.categoria_id),o&&"Ruta"==o.nombre){if(null==i)throw SwalToast("warning","Fecha Obligatoria",2500);if(null==n)throw SwalToast("warning","Horas Obligatorias",2500);const a=new Date(i).toISOString().split("T")[0];d.origen&&void 0!==d.origen.aeropuerto_id&&(d.origen=d.origen.aeropuerto_id),d.destino&&void 0!==d.destino.aeropuerto_id&&(d.destino=d.destino.aeropuerto_id),d.fecha_salida=a}a.push(d)}else if(o&&"Pernocta"==o.nombre){if(null==r)throw SwalToast("warning","Concepto Obligatorio para Pernocta",2500);d={...e.data},d.categoria&&void 0!==d.categoria.categoria_id&&(d.categoria=d.categoria.categoria_id),a.push(d)}})}catch(e){return a=""}return a}async function validarPasajeros(){const a=[];return document.querySelectorAll("#formPasajeros .cont-pasajero").forEach((e,t)=>{let o=e.querySelector('input[id^="paxName"]'),r=e.querySelector('input[id^="paxFile"]'),i={};if(o&&""!==o.value.trim()){let e=o.dataset.pax;e&&(i.pasajero_id=e.trim()),r&&r.files.length>0&&(i.nombre_ruta=r.files[0]),i.nombre=o.value.trim(),a.push(i)}}),a}async function validarRutaPax(){const a=[];return $("#formRelRuta").find("p[data-id]").each((function(){const e=$(this).attr("data-id");$(this).find("p[data-paxid]").each((function(){const t=$(this).attr("data-paxid");e&&t&&a.push({ruta_id:e,pasajero_id:t})}))})),a}async function consecutivoLineID(){const a=[];gridApi.forEachNode(e=>a.push(e.data));let e=0;a.forEach(a=>{a.line_id&&a.line_id>e&&(e=a.line_id)}),console.log(a);return e+1||1}async function relRutasPax2(a){a.classList.contains("expanded")||gridApi.forEachNode((function(a){if(a.data.categoria&&"Ruta"==a.data.categoria.nombre){let e=document.createElement("p");e.textContent="Ruta: "+a.data.concepto,e.setAttribute("data-id",a.data.relaciones_id);let t=document.createElement("select");t.name="seleccion-"+a.data.relaciones_id;let o=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),r=document.createElement("option");r.value="",r.textContent="",r.disabled=!0,r.selected=!0,t.appendChild(r),o.forEach(a=>{let e=$("#"+a.id).val(),o=$("#"+a.id).data("pax"),r=document.createElement("option");r.value=e,r.textContent=e,r.textContent=e,r.setAttribute("data-pax",o),t.appendChild(r),t.appendChild(r)});let i={};t.addEventListener("change",(function(){let a=t.value,o=t.options[t.selectedIndex].getAttribute("data-pax"),r=e.getAttribute("data-id");if(i[r]||(i[r]=[]),i[r].includes(o))return void console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!");i[r].push(o);let n=document.createElement("p");n.textContent="Pasajero: "+a,n.setAttribute("data-paxid",o),e.insertBefore(n,t)})),e.appendChild(t),document.getElementById("formRelRuta").appendChild(e)}}))}async function relRutasPax(a,e){if(a.classList.contains("expanded"))return;let t=(await obtenerRutPaxCot($("#cotizar_id").val())).reduce((a,e)=>(a[e.ruta_id]||(a[e.ruta_id]=[]),a[e.ruta_id].push(e),a),{}),o={};gridApi.forEachNode((function(a){if(a.data.categoria&&"Ruta"==a.data.categoria.nombre){let e=document.createElement("p");e.textContent="Ruta: "+a.data.concepto,e.setAttribute("data-id",a.data.relaciones_id);let r=document.createElement("select");r.name="seleccion-"+a.data.relaciones_id;let i=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),n=document.createElement("option");n.value="",n.textContent="",n.disabled=!0,n.selected=!0,r.appendChild(n),i.forEach(a=>{let e=$("#"+a.id).val(),t=$("#"+a.id).data("pax"),o=document.createElement("option");o.value=e,o.textContent=e,o.setAttribute("data-pax",t),r.appendChild(o)}),r.addEventListener("change",(function(){let a=r.value,t=r.options[r.selectedIndex].getAttribute("data-pax"),i=e.getAttribute("data-id");if(o[i]||(o[i]=[]),console.log(o),o[i].includes(t))return void console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!");o[i].push(t);let n=document.createElement("p");n.textContent="Pasajero: "+a,n.setAttribute("data-paxid",t),e.insertBefore(n,r)})),e.appendChild(r),document.getElementById("formRelRuta").appendChild(e),t[a.data.relaciones_id]&&(t[a.data.relaciones_id].forEach(t=>{let i=document.createElement("p");i.textContent="Pasajero: "+t.nombre,i.setAttribute("data-paxid",t.pasajero_id),e.insertBefore(i,r);let n=Array.from(r.options).find(a=>a.getAttribute("data-pax")==t.pasajero_id);n&&(n.selected=!0),o[a.data.relaciones_id]||(o[a.data.relaciones_id.toString()]=[]),o[a.data.relaciones_id].push(t.pasajero_id.toString())}),console.log(o))}}))}async function obtenerCotizaciones(){try{const a=await fetch("../obtener/cotizaciones",{method:"GET"}),e=await a.json();let t=verificarArray(e);gridApi.setGridOption("rowData",t)}catch(a){console.error(a),SwalToast("warning","Error al obtener las cotizaciones",2500)}}async function obtnerVuelosId(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/vuelos",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function establecerAsientos(){let a=await obtenerAeronaves(),e=$("#aeronave_id").val();const t=a.find(a=>a.aeronave_id==e);t&&(PASAJEROS=t.asientos)}async function validaRutaTarifa(a,e){try{let t=$("#cliente_id").val(),o=$("#broker_id").val();const r=$("#aeronave_id").val(),i=new FormData;i.append("origen",a),i.append("destino",e),i.append("cliente_id",t),i.append("broker_id",o),i.append("aeronave_id",r);const n=await fetch("../valida/ruta",{method:"POST",body:i});return await n.json()}catch(a){console.error(a),SwalToast("warning","Error al obtener los usuarios",2500)}}async function obtenerAeropuertos(){try{const a=await fetch("../allAeropuertos",{method:"GET"}),e=await a.json();return!e.length>0?SwalToast("warning","No hay Aeropuertos disponibles.",2500):AEROPUERTOS=e,e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerTipoCambio(){try{const a=await fetch("../tipo/cambio",{method:"GET"}),e=await a.json();return e?($("#tipo_cambio option").val(e.tipo_cambio_id),$("#tipo_cambio option").text(parseFloat(e.tipo_cambio).toFixed(2))):SwalToast("warning","No hay Tipo de Cambio.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerCategorias(){try{const a=await fetch("../obtener/categorias",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Categorias disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerProductos(){try{const a=await fetch("../obtener/productos",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Productos disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerAeronaves(){try{const a=await fetch("../allAeronaves",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Aeronaves disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerClientes(){try{const a=await fetch("../allClientes",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Clientes disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerEmpresas(){try{const a=await fetch("../brokers/activas",{method:"GET"}),e=await a.json();return!e.length>0?SwalToast("warning","No hay Programas disponibles.",2500):EMPRESAS=e,e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerCodigosIATA(a,e){try{const t=new FormData;t.append("origen",a),t.append("destino",e);const o=await fetch("../obtener/codigos",{method:"POST",body:t});return await o.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerTasaAterrizaje(a,e){try{const t=new FormData;t.append("origen",a),t.append("aeronave_id",e);const o=await fetch("../valida/aterrizaje",{method:"POST",body:t});return await o.json()}catch(a){console.error(a),SwalToast("warning","Error al obtener los usuarios",2500)}}async function obtenerCotizacionPDF(){try{const a=await fetch("../obtener/pdf",{method:"GET",headers:{Accept:"application/pdf"}}),e=await a.json();return void(e.urlArchivo?window.open(e.urlArchivo,"_blank"):console.error("No se pudo obtener la URL del archivo PDF."))}catch(a){console.error(a),SwalToast("warning","Error al obtener los usuarios",2500)}}async function validarDetEliminar(a,e){if("Ruta"===e.data.categoria.nombre){$("#aeronave_id").val();gridApi.forEachNode(async e=>{const t=e.data,o=e;t.categoria&&"Pernocta"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id)),t.categoria&&"Tua"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id)),t.categoria&&"Aterrizaje"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id))})}await eliminarDet(e.data.cot_det_id),limpiarCelda(e)}async function crearCotizacion(){try{const a=new FormData,e=$("#aeronave_id").val(),t=$("#fecha-cot").val(),o=$("#estatus").val();if(1==$("#slctOpcion").val()){const e=$("#cliente_id").val();a.append("cliente_id",e)}else if(2==$("#slctOpcion").val()){const e=$("#broker_id").val();a.append("broker_id",e)}const r=$("#tipo_cambio").val(),i=$("#cant_pernocta").val(),n=sinComa($("#tot_pernocta").val()),d=sinComa($("#tot_hrs").val()),c=sinComa($("#subtotal").val()),l=sinComa($("#ivaNac").val()),s=sinComa($("#ivaInt").val()),p=sinComa($("#total").val()),u=$("#costo_id").val(),m=$("#rt-comment").val();let h=0,g=await validarGrid(),f=await validarPasajeros();if(g.length>0){let v=g[0].origen,_=g[0].destino;if(1==g.length)h=1;else if(2==g.length){let a=g[1].origen;h=v==g[1].destino&&_==a?2:3}else h=3;a.append("aeronave_id",e),a.append("fechaCot",t),a.append("estatus",o),a.append("tipo_cambio_id",r),a.append("cant_pernocta",i),a.append("tot_pernocta",n),a.append("tot_hr_cotizadas",d),a.append("subtotal",c),a.append("ivaNac",l),a.append("ivaInt",s),a.append("total",p),a.append("tipo_de_viaje",h),a.append("costo_id",u),a.append("comentarios",m),a.append("pasajerosDet",JSON.stringify(f)),a.append("detalles",JSON.stringify(g)),f.forEach((e,t)=>{if(e&&e.nombre){let t;e.pasajero_id?(t=e.pasajero_id,a.append("archivo_"+t,e.nombre_ruta)):(t=e.nombre.split(" ").map(a=>a.charAt(0)).join(""),a.append("archivo_"+t,e.nombre_ruta))}});const b=await fetch("../crear/costeo",{method:"POST",body:a}),w=await b.json();if(1==w.exito?(SwalLoad("success","Éxito","Registro Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==w.exito&&SwalLoad("error","Error en la Transacción",w.errorSMS,!0),w.alertas)return void SwalToast("warning",w.alertas.error,2500)}}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarCotizacion(){try{const a=new FormData,e=$("#cotizar_id").val(),t=$("#folio").val(),o=$("#estatus").val(),r=$("#fecha-cot").val(),i=$("#aeronave_id").val();if(1==$("#slctOpcion").val()){const e=$("#cliente_id").val();a.append("cliente_id",e)}else if(2==$("#slctOpcion").val()){const e=$("#broker_id").val();a.append("broker_id",e)}const n=$("#tipo_cambio").val(),d=$("#cant_pernocta").val(),c=sinComa($("#tot_pernocta").val()),l=sinComa($("#tot_hrs").val()),s=sinComa($("#subtotal").val()),p=sinComa($("#ivaNac").val()),u=sinComa($("#ivaInt").val()),m=sinComa($("#total").val()),h=$("#costo_id").val(),g=$("#rt-comment").val();let f=0,v=await validarGrid(),_=await validarPasajeros();if(v.length>0){let b=v[0].origen,w=v[0].destino;if(1==v.length)f=1;else if(2==v.length){let a=v[1].origen;f=b==v[1].destino&&w==a?2:3}else f=3;a.append("cotizar_id",e),a.append("folio_cotizar",t),a.append("aeronave_id",i),a.append("fecha_creacion",r),a.append("estatus",o),a.append("tipo_cambio_id",n),a.append("cant_pernocta",d),a.append("tot_pernocta",c),a.append("tot_hr_cotizadas",l),a.append("subtotal",s),a.append("ivaNac",p),a.append("ivaInt",u),a.append("total",m),a.append("comentarios",g),a.append("tipo_de_viaje",f),a.append("costo_id",h),a.append("pasajerosDet",JSON.stringify(_)),a.append("detalles",JSON.stringify(v)),_.forEach((e,t)=>{if(e&&e.nombre){let t;e.pasajero_id?(t=e.pasajero_id,a.append("archivo_"+t,e.nombre_ruta)):(t=e.nombre.split(" ").map(a=>a.charAt(0)).join(""),a.append("archivo_"+t,e.nombre_ruta))}});const C=await fetch("../actualizar/costeo",{method:"POST",body:a}),E=await C.json();if(1==E.exito?(SwalLoad("success","Éxito","Registro Actualizado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==E.exito&&SwalLoad("error","Error en la Transacción",E.errorSMS,!0),E.alertas)return void SwalToast("warning",E.alertas.error,2500)}}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarRutaPax(){try{let a=await validarRutaPax();if(""==a)return;const e=$("#cotizar_id").val(),t=new FormData;t.append("id_cot",e),t.append("relRutaPax",JSON.stringify(a));const o=await fetch("../actualizar/relacionRutaPax",{method:"POST",body:t}),r=await o.json();console.log(r),$("#formRelRuta").empty()}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function eliminarDet(a){try{const e=$("#cotizar_id").val(),t=new FormData;t.append("cot_det_id",a),t.append("cotizar_id",e);const o=await fetch("../eliminar/detalle",{method:"POST",body:t}),r=await o.json();if(1==r.exito&&SwalToast("success","Registro Eliminado Correctamente",2500),r.alertas)return void SwalToast("warning",r.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function eliminarPasajero(a,e){try{const t=new FormData;t.append("cotizar_id",a),t.append("pasajero_id",e);const o=await fetch("../eliminar/pasajero",{method:"POST",body:t}),r=await o.json();if(1==r.exito&&SwalToast("success","Registro Eliminado Correctamente",2500),r.alertas)return void SwalToast("warning",r.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function generarServicio(){try{const a=$("#cotizar_id").val(),e=new FormData;e.append("cotizar_id",a);const t=await fetch("../generar/servicio",{method:"POST",body:e}),o=await t.json();if(1==o.exito?(SwalLoad("success","Éxito","Servicio Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==o.exito&&SwalLoad("error","Error en la Transacción",o.errorSMS,!0),o.alertas)return void SwalToast("warning",o.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}$((function(){asignarEventos(),inicializarPagina(),configurarBotones()}));class CustomHeaderGroup{init(a){this.params=a,this.eGui=document.createElement("div"),this.eGui.className="ag-header-group-cell-label",this.eGui.innerHTML='<div class="customHeaderLabel">'+this.params.displayName+'</div><div class="customExpandButton"><i class="fa fa-arrow-right"></i></div>',this.onExpandButtonClickedListener=this.expandOrCollapse.bind(this),this.eExpandButton=this.eGui.querySelector(".customExpandButton"),this.eExpandButton.addEventListener("click",this.onExpandButtonClickedListener),this.onExpandChangedListener=this.syncExpandButtons.bind(this),this.params.columnGroup.getProvidedColumnGroup().addEventListener("expandedChanged",this.onExpandChangedListener),this.syncExpandButtons()}getGui(){return this.eGui}expandOrCollapse(){var a=this.params.columnGroup.getProvidedColumnGroup().isExpanded();this.params.setExpanded(!a)}syncExpandButtons(){var a,e;this.params.columnGroup.getProvidedColumnGroup().isExpanded()?(e=this.eExpandButton).className=e.className.split(" ")[0]+" expanded":(a=this.eExpandButton).className=a.className.split(" ")[0]+" collapsed"}destroy(){this.eExpandButton.removeEventListener("click",this.onExpandButtonClickedListener)}}
//# sourceMappingURL=costeonew.js.map
