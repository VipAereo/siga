let gridOptions,PASAJEROS="";function asignarEventos(){$(".contenedor-altas").hide(),$(".costeo-relacion").hide(),$(".btn-pdf").hide(),$("#btnServicio").hide(),$("#myGrid2").addClass("event-none"),$(".aeroSearch").hide(),$(".emprSearch").hide(),$(".cliSearch").hide(),$(".paxSearch").hide(),aplicarMascaraCantidad("subtotal","ivaNac","ivaInt","total","cant_pernocta","tot_pernocta","cant_hrs","tot_hrs"),document.addEventListener("keydown",a=>{"Escape"===a.key&&resetForm()}),document.getElementById("aeronave_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".aeroSearch").show(),$(".inAeroSrch").focus();let e=await obtenerAeronaves();const t=await mostrarListaSearch(e,".aeroSearch","aeronave_id","modelo");t&&(PASAJEROS=t.asientos,activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]}))})),document.getElementById("pasajero_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".paxSearch").show(),$(".inPaxSrch").focus();let e=await obtenerPasajeros();const t=await mostrarListaSearch(e,".paxSearch","pasajero_id","nombre",!0);"nuevo"==t?($("#pasajero_id option").val(),$("#pasajero_id option").text(""),nuevoPax()):($("#pasajero_id option").val(),$("#pasajero_id option").text(""),setPaxId(t))})),document.getElementById("slctOpcion").addEventListener("change",(async function(a){mostrarClienteEmpresa()})),document.getElementById("cliente_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".cliSearch").show(),$(".inCliSrch").focus();let e=await obtenerClientes();await mostrarListaSearch(e,".cliSearch","cliente_id","nombre")&&(activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]}))})),document.getElementById("broker_id").addEventListener("mousedown",(async function(a){a.preventDefault(),$(".emprSearch").show(),$(".inEmprSrch").focus();let e=await obtenerEmpresas();const t=await mostrarListaSearch(e,".emprSearch","broker_id","nombre");t&&(activarRutas(),gridApi.updateGridOptions({rowData:["","","","","","","",""]})),$("#rt-responsable").val(t.contacto_principal)}));const a=document.querySelector(".toggle-pax"),e=document.querySelector(".toggle-pax-cont");a.addEventListener("click",(function(){e.classList.contains("expanded")?(e.classList.remove("expanded"),a.classList.remove("expanded"),$("#formPasajeros").addClass("toggle-pax-cont")):(e.classList.add("expanded"),a.classList.add("expanded"),$("#formPasajeros").removeClass("toggle-pax-cont"))}));const t=document.querySelector(".toggle-relRuta"),o=document.querySelector(".toggle-relRuta-cont");t.addEventListener("click",(async function(){o.classList.contains("expanded")?(o.classList.remove("expanded"),t.classList.remove("expanded"),$("#formRelRuta").empty()):(o.classList.add("expanded"),t.classList.add("expanded"))}));const r=document.querySelector(".toggle-relRuta");r.addEventListener("mousedown",(async function(){await relRutasPax(r)}))}function configurarBotones(){$("#crear-solCot").click(mostrarContenedorAltas),$("#btnCancel").click(a=>{resetForm()}),$("#actTipoCambio").click(async a=>{await obtenerTipoCambio()&&SwalToast("success","Tipo de Cambio Actualizado.",2500)}),$("#btnGuardar").click(async a=>{const e=validateInputs($("#formAltas")),t=$("#estatus").val();if(e&&(""==t||"PND"==t||"CTZ"==t))if($("#cotizar_id").val()){document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]")?(await actualizarCotizacion(),await actualizarRutaPax()):await actualizarCotizacion()}else await crearCotizacion()}),$("#genera_pdf").click(a=>{$("#cotizar_id").val()&&obtenerCotizacionPDF()}),$("#btnServicio").click(a=>{$("#cotizar_id").val()&&generarServicio()})}function inicializarPagina(){setFechaActual("fecha-cot");iniciarTabla("",[{headerName:"id",field:"cotizar_id",width:80},{headerName:"Folio",field:"folio_cotizar",width:80},{headerName:"Broker",field:"nombreBrok",width:110},{headerName:"Cliente",field:"nombreCli",width:110},{headerName:"Aeronave",field:"modeloAeronave",width:160},{headerName:"Ruta",field:"concepto",width:180},{headerName:"Fecha Salida",field:"fecha_salida",width:100},{headerName:"Total",field:"total",width:120,cellStyle:{textAlign:"right"},valueFormatter:function(a){return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Estatus",field:"estatus",width:80},{headerName:"Acción",cellRenderer:function(a){const e=document.createElement("I");e.className="fa-regular fa-pen-to-square btn btn-editar",e.title="Ver o Editar",e.addEventListener("click",(async function(e){if(0==Object.keys(a.data).length)return;$("#aeronave_id").prop("disabled",!0),$("#slctOpcion").prop("disabled",!0),$("#cliente_id").prop("disabled",!0),$("#broker_id").prop("disabled",!0),$("#cotizar_id").val(a.data.cotizar_id),$("#folio").val(a.data.folio_cotizar),$("#fecha-cot").val(formatearFechaCompleta(a.data.fecha_creacion)),$("#rt-comment").val(a.data.comentarios),$("#estatus").val(a.data.estatus),$("#aeronave_id option").val(a.data.aeronave_id),$("#aeronave_id option").text(a.data.modeloAeronave);let t=0;a.data.tipo_cambio?(t=a.data.tipo_cambio,$("#tipo_cambio option").val(a.data.tipo_cambio_id)):(t=await obtenerTipoCambio(),$("#tipo_cambio option").val(t.tipo_cambio_id),t=t.tipo_cambio),$("#tipo_cambio option").val(a.data.tipo_cambio_id),$("#tipo_cambio option").text(Number(t).toFixed(2)),await mostrarContenedorAltas(),a.data.cliente_id?($("#slctOpcion").val(1),mostrarClienteEmpresa(),$("#cliente_id option").val(a.data.cliente_id),$("#cliente_id option").text(a.data.nombreCli)):a.data.broker_id&&($("#slctOpcion").val(2),mostrarClienteEmpresa(),$("#broker_id option").val(a.data.broker_id),$("#broker_id option").text(a.data.nombreBrok),$("#rt-responsable").val(a.data.contacto_principal)),botonPdfCotizar();let o=await obtnerVuelosId(a.data.cotizar_id);if("PND"==$("#estatus").val()){let a=await Promise.all(Array.from(o).map(async a=>{let e=await validaRutaTarifa(a.origenId,a.destinoId),t=0;t="N"==e.ruta.tipo_vuelo?e.tarifa.costo_mx:e.tarifa.costo_usd;let o={cot_det_id:a.cot_det_id,fecha_salida:a.fecha_salida,hora_salida:a.hora_salida,categoria:{categoria_id:a.categoria_id,nombre:a.nombreCat},concepto:a.concepto,pasajeros:a.pasajeros,tipo_vuelo:a.tipo_vuelo,cantidad:1,percost:.5,tarifa:a.tarifa,subtotal:a.subtotal,rel_ruta:a.rel_ruta,relaciones_id:a.relacion_id,line_id:a.line_id,costo_id:e.tarifa.costo_id,tarifa:t};return 1==a.categoria_id&&(o.origen={aeropuerto_id:a.origenId,municipio:a.origMun},o.destino={aeropuerto_id:a.destinoId,municipio:a.destMun}),o}));if(a.length<9){const e=Array(8-a.length).fill({}),t=a.concat(e).map(a=>({...a}));gridApi.setGridOption("rowData",t)}else gridApi.setGridOption("rowData",a);gridApi.forEachNode(a=>{const e=a.data;Object.keys(e).length>0&&actTotalesLine(e)}),await obtenerTarifaCosto(),await generarTUA(),await generarAterrizajes(),await generarPernoctas()}else{let a=o.map(a=>{let e={cot_det_id:a.cot_det_id,fecha_salida:a.fecha_salida,hora_salida:a.hora_salida,categoria:{categoria_id:a.categoria_id,nombre:a.nombreCat},concepto:a.concepto,pasajeros:a.pasajeros,tipo_vuelo:a.tipo_vuelo,cantidad:a.cantidad,percost:a.percost,tarifa:a.tarifa,subtotal:a.subtotal,rel_ruta:a.rel_ruta,relaciones_id:a.relacion_id,line_id:a.line_id};return 1==a.categoria_id&&(e.origen={aeropuerto_id:a.origenId,municipio:a.origMun},e.destino={aeropuerto_id:a.destinoId,municipio:a.destMun}),e});if(a.length<9){const e=Array(8-a.length).fill({}),t=a.concat(e).map(a=>({...a}));gridApi.setGridOption("rowData",t)}else gridApi.setGridOption("rowData",a)}actTotales(),activarRutas();let r=await obtenerPax(a.data.cotizar_id);detallePax=r.pasajeros;let i=r.paxDoc;for(let a=0;a<detallePax.length;a++)nuevoPax();const n=document.querySelectorAll("#formPasajeros .cont-pasajero");n.length==detallePax.length&&n.forEach((a,e)=>{const t=detallePax[e].pasajero_id,o=detallePax[e].nombre,r=a.querySelector("#paxName"+(e+1));if(r.value=o,r.dataset.pax=t,i){const e=function(a){return i[a]?Array.isArray(i[a])?i[a]:[i[a]]:[]}(t),o=a.querySelector(".contenedor-docs");e.forEach(a=>{const e=document.createElement("a");e.classList.add("thumbnail"),e.href=`/${a.ruta}/${a.hash_doc}.${a.tipo_doc}`,e.setAttribute("target","_blank");const t=document.createElement("DIV");t.classList.add("fileicon");const r=document.createElement("I");r.classList.add("fa-regular","fa-file");const i=document.createElement("DIV");i.classList.add("filename");const n=document.createElement("P");n.textContent=""+a.nombre_doc,t.appendChild(r),i.appendChild(n),e.appendChild(t),e.appendChild(i),o.appendChild(e)})}}),await ordenarPorCategoria(),$(".costeo-relacion").show()}));const t=document.createElement("div");return t.classList="btn-cont centrado",t.appendChild(e),$(".pasajeros").prop("disabled",!1),t},width:150,headerClass:"txt-center",cellClass:"custom-action-cell",filter:!1}],"#myGrid"),obtenerCotizaciones()}async function configTablaCrear(){mostrarClienteEmpresa();let a=await obtenerAeropuertos(),e=await obtenerCategorias(),t=await obtenerProductos(),o=[{headerName:"Id",field:"cot_det_id",width:60},{headerName:"",headerGroupComponent:CustomHeaderGroup,children:[{headerName:"Fecha",field:"fecha_salida",width:100,cellEditor:"agDateCellEditor",editable:!0,valueFormatter:function(a){let e=a.value;return e?formatearFecha(e):null},cellClassRules:{"event-none":a=>{const e=a.data.categoria,t=a.data.fecha_salida;if(e&&t)return"Pernocta"==e.nombre||"Aterrizaje"==e.nombre}}},{headerName:"Hora",field:"hora_salida",width:120,editable:!0,columnGroupShow:"open",valueFormatter:function(a){if(null!==a.value&&void 0!==a.value){const e=a.value;let t=0,o=0;if(e)if(e.includes(":")){const a=e.split(":");t=a[0],o=a[1]}else t=e;else t=e;const r=parseFloat(t),i=parseFloat(o),n=`${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`;return/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/.test(n)?n:"00:00"}return null}}]},{headerName:"Cat",field:"categoria",width:80,cellEditor:"agSelectCellEditor",editable:!1,cellEditorParams:{values:["",...e.map(a=>({categoria_id:a.categoria_id,nombre:a.nombre}))]},valueFormatter:function(a){if(a.value)return a.value.nombre},valueGetter:function(a){return a.data.categoria?a.data.categoria.nombre:""},valueSetter:function(a){return a.data.categoria=a.newValue,!0},cellClassRules:{"event-none":a=>{const e=a.data.cot_det_id;return null!=e&&""!==e}}},{headerName:"Concepto",field:"concepto",width:160,editable:!1},{headerName:"Origen",field:"origen",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...a.map(a=>({aeropuerto_id:a.aeropuerto_id,municipio:a.municipio}))]},valueFormatter:function(a){if(a.value)return a.value.municipio},valueGetter:function(a){return a.data.origen?a.data.origen.municipio:""},valueSetter:function(a){return a.data.origen=a.newValue,!0}},{headerName:"Destino",field:"destino",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...a.map(a=>({aeropuerto_id:a.aeropuerto_id,municipio:a.municipio}))]},valueFormatter:function(a){if(a.value)return a.value.municipio},valueParser:function(a){if(a.value)return{aeropuerto_id:a.value.aeropuerto_id,municipio:a.value.municipio}},valueGetter:function(a){return a.data.destino?a.data.destino.municipio:""},cellClassRules:{"event-none":a=>{const e=a.data.cot_det_id;return null!=e&&""!==e}}},{headerName:"Pax",field:"pasajeros",width:60,editable:!0,cellEditor:"agNumberCellEditor",valueParser:function(a){return parseFloat(a.newValue)||null},valueFormatter:function(a){return null!==a.value&&void 0!==a.value?Math.round(a.value):null}},{headerName:"Tipo",field:"tipo_vuelo",width:80,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["N","I"]},valueFormatter:function(a){const e=a.value;return"I"===e?"Internacional":"N"===e?"Nacional":e},editable:!1},{headerName:"",headerGroupComponent:CustomHeaderGroup,children:[{headerName:"Cant",field:"cantidad",width:80,cellEditor:"agNumberCellEditor",editable:!0,valueParser:function(a){return value=a.newValue,0==value&&(value=1),value},valueFormatter:function(a){return"number"!=typeof a.value||isNaN(a.value)?null:a.value.toFixed(1)}},{headerName:"Pernocta Costo",field:"percost",width:80,cellEditor:"agNumberCellEditor",editable:!0,columnGroupShow:"open",valueParser:function(a){return"0"==a.newValue?.5:parseFloat(a.newValue)||null},valueFormatter:function(a){return"number"!=typeof a.value||isNaN(a.value)?null:a.value.toFixed(1)}}]},{headerName:"Tarifa",field:"tarifa",width:100,editable:!0,cellStyle:{textAlign:"right"},cellEditor:"agNumberCellEditor",valueFormatter:function(a){if(a.value)return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Subtotal",field:"subtotal",width:100,cellStyle:{textAlign:"right"},valueFormatter:function(a){if(a.value)return Number(a.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Relacion Ruta",field:"rel_ruta",width:80},{headerName:"Relacion",field:"relaciones_id",width:80},{headerName:"LineID",field:"line_id",width:80},{headerName:"Acción",width:90,cellRenderer:function(a){const e=$("#estatus").val();if(("PND"==e||"CTZ"==e||""==e)&&a.data.categoria&&a.data.categoria.nombre){const e=document.createElement("I");e.className="fa-regular fa-trash-can btn btn-eliminar",e.title="Eliminar",e.addEventListener("click",(async function(){if(0==Object.keys(a.data).length)return;const e=a.data.cot_det_id,t=a.node;e?(await validarDetEliminar(e,t),actTotales(),actualizarCotizacion()):(limpiarCelda(t),actTotales())}));const t=document.createElement("div");return t.classList="btn-cont centrado",t.appendChild(e),t}},headerClass:"txt-center",cellClass:"custom-action-cell",filter:!1}];iniciarTabla("",o,"#myGrid2"),$("#cotizar_id").val()||await obtenerTipoCambio(),establecerAsientos(),gridApi.addEventListener("cellValueChanged",(async function(a){const e=a.column.colId,t=a.node.data,o=a.rowIndex;let r=t.origen?t.origen.aeropuerto_id:"",i=t.destino?t.destino.aeropuerto_id:"";if("origen"==e||"destino"==e){if($("#aeronave_id").val()){if(r&&i){let a=await validaRutaTarifa(r,i);if("0"==a.exito){SwalToast("warning",a.alertas.error[0],2500);let e=gridApi.getRowNode(o);e&&e.data&&Object.keys(e.data).forEach(a=>{e.setDataValue(a,null)})}else{$("#costo_id").val(a.tarifa.costo_id),"N"==a.ruta.tipo_vuelo?(t.tarifa=a.tarifa.costo_mx,t.subtotal=a.tarifa.costo_mx):"I"==a.ruta.tipo_vuelo&&(t.tarifa=a.tarifa.costo_usd,t.subtotal=a.tarifa.costo_usd),t.tipo_vuelo=a.ruta.tipo_vuelo,t.relaciones_id=a.ruta.ruta_id,t.rel_ruta=a.ruta.ruta_id,t.hora_salida="00:00",t.cantidad="1";let e="";"Ruta"==t.categoria.nombre&&(e=await obtenerCodigosIATA(r,i),t.concepto=e);let o=await consecutivoLineID();t.line_id=o,await generarPernoctas(),await generarAterrizajes(),await generarTUA(),await ordenarPorCategoria(),actTotales()}}}else SwalToast("warning","Selecciona una Aeronave",2500)}if("fecha_salida"==e&&r&&i&&(await generarPernoctas(),await ordenarPorCategoria()),"pasajeros"==e){const e=a.newValue;a.oldValue;if(e>PASAJEROS&&(t.pasajeros=PASAJEROS,gridApi.applyTransaction({update:[t]})),t.origen&&t.destino){const a=[];gridApi.forEachNode(e=>{const t=e.data;t.categoria&&"Ruta"===t.categoria.nombre&&t.origen&&t.destino&&a.push(t)}),await generarTUA(),await ordenarPorCategoria()}}a.oldValue!==a.newValue&&!isNaN(a.oldValue)&&!isNaN(a.newValue)&&null!==a.oldValue&&void 0!==a.oldValue&&null!==a.newValue&&void 0!==a.newValue&&t.categoria&&(t.percost||t.categoria||t.tarifa||t.cantidad)&&(actTotalesLine(t),actTotales())})),gridApi.addEventListener("cellDoubleClicked",(async function(o){const r=o.column.colId,i=o.node.data,n=o.rowIndex,d=o.event.target;if("categoria"==r){const a=e.map(a=>({id:a.categoria_id,nombre:a.nombre}));let t=await mostrarListaGrid(d,a,"#filtro",".contenedor-altas"),o=gridApi.getRowNode(n);i.categoria&&limpiarCelda(o),o=gridApi.getRowNode(n);const r={categoria_id:t.id,nombre:t.nombre};o.setDataValue("categoria",r),gridApi.redrawRows()}if("concepto"==r&&i.categoria){if("Producto"==i.categoria.nombre){const a=t.map(a=>({id:a.producto_id,nombre:a.nombre}));let e=await mostrarListaGrid(d,a,"#filtro",".contenedor-altas"),o=await consecutivoLineID();const r=gridApi.getRowNode(n),i=t.find(a=>a.producto_id===e.id);r.setDataValue("fecha_salida",obtenerFechaActual()),r.setDataValue("concepto",e.nombre),r.setDataValue("relaciones_id",e.id),r.setDataValue("tarifa",i.precio),r.setDataValue("cantidad","1"),r.setDataValue("line_id",o),r.setDataValue("subtotal",1*i.precio),gridApi.redrawRows()}i.categoria.nombre,i.categoria.nombre,i.categoria.nombre}if("origen"===r||"destino"===r){const e=a.map(a=>({id:a.aeropuerto_id,nombre:a.municipio}));if(i.categoria&&"Ruta"==i.categoria.nombre&&(!i||!i.cot_det_id)){let a=await mostrarListaGrid(d,e,"#filtro",".contenedor-altas");const t=gridApi.getRowNode(n),o={aeropuerto_id:a.id,municipio:a.nombre};"origen"===r?t.setDataValue("origen",o):t.setDataValue("destino",o),gridApi.redrawRows()}}}))}function limpiarCelda(a){const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)});e.forEach(a=>{a.colId}),a.setData({})}function actTotalesLine(a){if(!a)return;const e=a.line_id;gridApi.forEachNode(a=>{if(a.data.line_id===e&&a.data.categoria){const e=a.data.categoria.nombre,t=a.data.percost,o=a.data.cantidad,r=a.data.tarifa;let i=0;i="Ruta"==e?o*r:"Pernocta"==e?o*t*r:"Aterrizaje"==e?r:o*r,a.setDataValue("subtotal",i)}gridApi.refreshCells({force:!0})})}function actTotales(){let a=0,e=0,t=0,o=0,r=0,i=0,n=0,d=0,c=0;gridApi.forEachNode(d=>{const c=parseFloat(d.data.cantidad||0),l=parseFloat(d.data.subtotal||0);d.data.categoria&&"Pernocta"==d.data.categoria.nombre&&(a+=c,e+=l),d.data.categoria&&"Ruta"==d.data.categoria.nombre&&(t+=c,o+=l),r+=l,"N"==d.data.tipo_vuelo?i+=l:"I"==d.data.tipo_vuelo&&(n+=l)}),d=.16*i,c=.04*n,$("#cant_pernocta").val(a),$("#tot_pernocta").val(e),$("#cant_hrs").val(t),$("#tot_hrs").val(o),$("#subtotal").val(r),$("#ivaNac").val(d),$("#ivaInt").val(c),$("#total").val(r+d+c)}function mostrarClienteEmpresa(){let a=$("#slctOpcion").val();1==a?($("#inpCliente").show(),$("#inpEmpresa").hide(),$("label[for='cliente_id']").addClass("labelImportant"),$("label[for='broker_id']").removeClass("labelImportant"),$("select[id='broker_id'] option").val(""),$("select[id='broker_id'] option").text("")):2==a&&($("#inpCliente").hide(),$("#inpEmpresa").show(),$("label[for='broker_id']").addClass("labelImportant"),$("label[for='cliente_id']").removeClass("labelImportant"),$("select[id='cliente_id'] option").val(""),$("select[id='cliente_id'] option").text(""))}function activarRutas(){let a=$("#aeronave_id").val(),e=$("#cliente_id").val(),t=$("#broker_id").val(),o=$("#estatus").val();("PND"==o||"CTZ"==o||""==o)&&""!==a&&(""!==e||""!==t)?($("#myGrid2").removeClass("event-none"),$("#formTotales").removeClass("event-none"),$("#formPasajeros").removeClass("event-none")):($("#myGrid2").addClass("event-none"),$("#formTotales").addClass("event-none"),$("#formPasajeros").addClass("event-none"))}async function ordenarPorCategoria(){const a=[],e=[],t=[],o=[],r=[];gridApi.forEachNode(i=>{const n=i.data;a.push(n),n.categoria&&("Ruta"==n.categoria.nombre?e.push(n):n.categoria&&"Pernocta"==n.categoria.nombre?o.push(n):n.categoria&&"Aterrizaje"==n.categoria.nombre?t.push(n):r.push(n))});let i=[...e,...o,...t,...r];if(i.push({}),i.length<9){const a=Array(8-i.length).fill({}),e=i.concat(a).map(a=>({...a}));gridApi.updateGridOptions({rowData:e})}else gridApi.updateGridOptions({rowData:i})}async function generarPernoctas(){const a=[];if(gridApi.forEachNode(e=>{let t=e.data.categoria,o=e.data.cot_det_id;t&&"Pernocta"===e.data.categoria.nombre&&!o&&a.push(e.data)}),a.length>0){gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)}),gridApi.updateGridOptions({rowData:e})}const e=[],t={};if(gridApi.forEachNode(a=>{const o=a.data;o.categoria&&"Ruta"===o.categoria.nombre&&o.origen&&o.destino?e.push(o):o.categoria&&"Pernocta"===o.categoria.nombre&&(t[o.rel_ruta]=o)}),e.length>1){const a=[];let o=await consecutivoLineID();for(let r=0;r<e.length-1;r++){const i=formatearFecha(e[r].fecha_salida),n=obtenerDia(i);let d=e[r].concepto;d=d.substring(d.lastIndexOf(" ")+1);const c=e[r].tarifa,l=e[r].relaciones_id,s=e[r].line_id,p=formatearFecha(e[r+1].fecha_salida),u=calcularDiferenciaDias(i,p);if(u>0)if(t[s])t[l].concepto=`${d} - Día: ${n}`,t[l].cantidad=u,t[l].subtotal=.5*u*c;else{const e={cot_det_id:"",fecha_salida:i,hora_salida:"0",categoria:{categoria_id:2,nombre:"Pernocta"},concepto:`${d} - Día: ${n}`,origen:"",destino:"",pasajeros:"",tipo_vuelo:"",cantidad:u,tarifa:c,percost:"0.5",subtotal:.5*u*c,rel_ruta:s,line_id:o};o++,a.push(e)}}a.length>0&&gridApi.applyTransaction({add:a});const r=Object.values(t).filter(a=>void 0!==a.cantidad);r.length>0&&gridApi.applyTransaction({update:r})}}async function generarAterrizajes(){const a=[];if(gridApi.forEachNode(e=>{let t=e.data.categoria,o=e.data.cot_det_id;t&&"Aterrizaje"===e.data.categoria.nombre&&!o&&a.push(e.data)}),a.length>0){gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)}),gridApi.updateGridOptions({rowData:e})}const e=[],t={};if(gridApi.forEachNode(a=>{const o=a.data;o.categoria&&"Ruta"===o.categoria.nombre&&o.origen&&o.destino?e.push(o):o.categoria&&"Aterrizaje"===o.categoria.nombre&&(t[o.rel_ruta]=o)}),e.length>0){const a=[],o=$("#aeronave_id").val();let r=await consecutivoLineID();for(i in e)if(e[i].destino){const n=e[i].destino.aeropuerto_id;let d=e[i].concepto;d=d.substring(d.lastIndexOf(" ")+1);const c=e[i].line_id,l=formatearFecha(e[i].fecha_salida);if(!t[c]){const e=await obtenerTasaAterrizaje(n,o);if(1==e.exito){const t={cot_det_id:"",fecha_salida:l,hora_salida:"0",categoria:{categoria_id:3,nombre:"Aterrizaje"},concepto:d,origen:"",destino:"",pax:"",tipo_vuelo:"",tarifa:e.aterrizaje.tarifa_aterrizaje,subtotal:e.aterrizaje.tarifa_aterrizaje,relaciones_id:e.aterrizaje.tasa_aterrizaje_id,rel_ruta:c,line_id:r,cantidad:1};r++,a.push(t)}}}a.length>0&&gridApi.applyTransaction({add:a});const n=Object.values(t).filter(a=>void 0!==a.cantidad);n.length>0&&gridApi.applyTransaction({update:n})}}async function generarTUA(){const a=[];if(gridApi.forEachNode(e=>{let t=e.data.categoria,o=e.data.cot_det_id;t&&"Tua"===e.data.categoria.nombre&&!o&&a.push(e.data)}),a.length>0){gridApi.applyTransaction({remove:a});const e=[];gridApi.forEachNode(a=>{const t=a.data;e.push(t)}),gridApi.updateGridOptions({rowData:e})}const e=[],t={};gridApi.forEachNode(a=>{const o=a.data;o.categoria&&"Ruta"===o.categoria.nombre&&o.origen&&o.destino?e.push(o):o.categoria&&"Tua"===o.categoria.nombre&&(t[o.rel_ruta]=o)});const o=await obtenerTipoCambio();if(o&&e.length>0){const a=[],r=[];let i=await consecutivoLineID();const n=await obtenerAeropuertos();for(let d=0;d<e.length;d++){const c=e[d].origen.aeropuerto_id,l=e[d].pasajeros,s=e[d],p=s.line_id,u=s.concepto,m=formatearFecha(s.fecha_salida),f=n.find(a=>a.aeropuerto_id==c);if(f&&f.costo_tua){const e=parseFloat(f.costo_tua)/parseFloat(o.tipo_cambio),n=parseFloat(f.costo_tua)/parseFloat(o.tipo_cambio)*l;if(t[p])t[p].cantidad=l,t[p].tarifa=e,t[p].subtotal=n,r.push(t[p]);else if(l>0){const t={cot_det_id:"",fecha_salida:m,hora_salida:"0",categoria:{categoria_id:5,nombre:"Tua"},concepto:""+u,origen:"",destino:"",pax:"",tipo_vuelo:"",cantidad:l,tarifa:e,subtotal:n,relaciones_id:f.aeropuerto_id,rel_ruta:p,line_id:i};i++,a.push(t)}}}a.length>0&&gridApi.applyTransaction({add:a}),r.length>0&&gridApi.applyTransaction({update:r})}}function resetForm(){resetearTabla("#myGrid2","#searchInput1"),cerrarVentana(".contenedor-altas",["#formAltas","#formTotales"]),$("#inpCliente").hide(),$("#inpEmpresa").hide(),$("#inpGeneral").hide(),$("#aeronave_id").prop("disabled",!1),$("#slctOpcion").prop("disabled",!1),$("#cliente_id").prop("disabled",!1),$("#broker_id").prop("disabled",!1);const a=document.querySelectorAll("#formPasajeros .cont-pasajero");for(let e=0;e<a.length;e++)a[e].remove();$("#formRelRuta").empty(),botonPdfCotizar(),PASAJEROS="",MAXPAX=0,limpiarForm("#formAltas"),obtenerCotizaciones()}async function mostrarContenedorAltas(){await configTablaCrear(),$(".contenedor-altas").show()}function botonPdfCotizar(){$(".btn-pdf").toggle(["CTZ","SVC","CMP"].includes($("#estatus").val())),$("#btnServicio").toggle("CTZ"===$("#estatus").val())}function nuevoPax(){const a=document.getElementById("formPasajeros");document.getElementById("btnPasajero"),document.getElementById("pasajero_id");let e=a.querySelectorAll(".cont-pasajero").length+1;const t=document.createElement("DIV");t.classList.add("cont-form3","cont-pasajero");const o=document.createElement("DIV");o.classList.add("form-group");const r=document.createElement("INPUT");r.type="text",r.id="pasajero_id"+e,r.classList.add("hidden");const i=document.createElement("INPUT");i.type="text",i.id="paxName"+e,i.placeholder="",o.appendChild(i);const n=document.createElement("LABEL");n.textContent="Pasajero "+e+":",n.htmlFor="paxName"+e,o.appendChild(n),t.appendChild(o);const d=document.createElement("DIV");d.classList.add("form-group");const c=document.createElement("INPUT");c.type="file",c.name="paxFile"+e,c.id="paxFile"+e,c.accept="image/*",d.appendChild(c);const l=document.createElement("A");l.id="btnEliminarPax"+e,l.classList.add("btn","btn-eliminarPax"),l.title="Eliminar Pasajero";const s=document.createElement("DIV");s.classList.add("contenedor-docs","flex"),d.appendChild(l),t.appendChild(d),a.appendChild(t),t.appendChild(s),$("#btnEliminarPax"+e).on("click",(async function(){const a=$("#cotizar_id").val(),e=$(this).closest(".cont-pasajero").find('input[id^="paxName"]').data("pax");a&&e&&await eliminarPasajero(a,e),$(this).closest(".cont-pasajero").remove()}))}async function setPaxId(a){let e=0;if(document.querySelectorAll("#formPasajeros .cont-pasajero").forEach((t,o)=>{let r=t.querySelector('input[id^="paxName"]');if(r){(r.dataset.paxn||r.dataset.pax)==a.pasajero_id&&(e=1)}}),0==e){const e=a.pasajero_id,t=await obtenerDocsbyPax(e),o=document.getElementById("formPasajeros");document.getElementById("btnPasajero"),document.getElementById("pasajero_id");let r=o.querySelectorAll(".cont-pasajero").length+1;const i=document.createElement("DIV");i.classList.add("cont-form3","cont-pasajero");const n=document.createElement("DIV");n.classList.add("form-group");const d=document.createElement("INPUT");d.type="text",d.id="pasajero_id"+r,d.classList.add("hidden");const c=document.createElement("INPUT");c.type="text",c.id="paxName"+r,c.placeholder="",c.value=a.nombre,c.setAttribute("data-paxN",e),n.appendChild(c);const l=document.createElement("LABEL");l.textContent="Pasajero "+r+":",l.htmlFor="paxName"+r,n.appendChild(l),i.appendChild(n);const s=document.createElement("DIV");s.classList.add("form-group");const p=document.createElement("INPUT");p.type="file",p.name="paxFile"+r,p.id="paxFile"+r,p.accept="image/*",s.appendChild(p);const u=document.createElement("A");u.id="btnEliminarPax"+r,u.classList.add("btn","btn-eliminarPax"),u.title="Eliminar Pasajero";const m=document.createElement("DIV");m.classList.add("contenedor-docs","flex"),s.appendChild(u),i.appendChild(s),o.appendChild(i),i.appendChild(m),t.length>0&&t.forEach(a=>{const e=document.createElement("a");e.classList.add("thumbnail"),e.href=`/${a.ruta}/${a.hash_doc}.${a.tipo_doc}`,e.setAttribute("target","_blank");const t=document.createElement("DIV");t.classList.add("fileicon");const o=document.createElement("I");o.classList.add("fa-regular","fa-file");const r=document.createElement("DIV");r.classList.add("filename");const i=document.createElement("P");i.textContent=""+a.nombre_doc,t.appendChild(o),r.appendChild(i),e.appendChild(t),e.appendChild(r),m.appendChild(e)}),$("#btnEliminarPax"+r).on("click",(async function(){$("#cotizar_id").val(),$(this).closest(".cont-pasajero").find('input[id^="paxName"]').data("paxn");$(this).closest(".cont-pasajero").remove()}))}}async function obtenerPax(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/pax",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function validarGrid(){let a=[];try{const e=[];gridApi.forEachNode(a=>e.push(a));for(const t of e){const e=t.data.relaciones_id,o=t.data.categoria,r=t.data.concepto,i=t.data.fecha_salida,n=t.data.cantidad;if(!i&&o)return SwalToast("warning","Fecha Obligatoria",2500),[];const d=formatearFechaYear(i);if(t.data.fecha_salida=d,t.data.categoria_nombre="",e){let e={...t.data};if(o&&(e.categoria_nombre=e.categoria.nombre),e.categoria&&void 0!==e.categoria.categoria_id&&(e.categoria=e.categoria.categoria_id),o&&"Ruta"==o.nombre){if(null==i)throw SwalToast("warning","Fecha Obligatoria",2500);if(null==n)throw SwalToast("warning","Horas Obligatorias",2500);const a=formatearFechaYear(i);e.origen&&void 0!==e.origen.aeropuerto_id&&(e.origen=e.origen.aeropuerto_id),e.destino&&void 0!==e.destino.aeropuerto_id&&(e.destino=e.destino.aeropuerto_id);const t=await formatoHora(e.hora_salida);e.hora_salida=t,e.fecha_salida=a}a.push(e)}else if(o&&"Pernocta"==o.nombre){if(null==r)throw SwalToast("warning","Concepto Obligatorio para Pernocta",2500);filaModificada={...t.data},filaModificada.categoria&&void 0!==filaModificada.categoria.categoria_id&&(filaModificada.categoria=filaModificada.categoria.categoria_id,filaModificada.categoria_nombre=o.nombre),a.push(filaModificada)}}}catch(a){return""}return a}async function validarGridPDF(){let a=[];gridApi.forEachNode(e=>{if(e.data.categoria){let t={...e.data};t.categoria=""+t.categoria.nombre,a.push(t)}});const e=(await obtenerCategorias()).map(a=>a.nombre);return a.sort((function(a,t){const o=new Date(a.fecha_salida),r=new Date(t.fecha_salida);if(o-r!=0)return o-r;const i=e.indexOf(a.categoria),n=e.indexOf(t.categoria);return i-n!=0?i-n:0!==a.concepto.localeCompare(t.concepto)?a.concepto.localeCompare(t.concepto):0!==a.destino.municipio.localeCompare(t.destino.municipio)?a.destino.municipio.localeCompare(t.destino.municipio):0!==a.origen.municipio.localeCompare(t.origen.municipio)?a.origen.municipio.localeCompare(t.origen.municipio):parseFloat(a.tarifa)-parseFloat(t.tarifa)})),a}async function validarPasajeros(){const a=[];return document.querySelectorAll("#formPasajeros .cont-pasajero").forEach((e,t)=>{let o=e.querySelector('input[id^="paxName"]'),r=e.querySelector('input[id^="paxFile"]'),i={};if(o&&""!==o.value.trim()||o&&o.dataset.paxn){let e=o.dataset.pax||o.dataset.paxn;e&&(i.pasajero_id=e.trim()),r&&r.files.length>0&&(i.nombre_ruta=r.files[0]),i.nombre=o.value.trim(),a.push(i)}}),a}async function validarRutaPax(){const a=[];return $("#formRelRuta").find("p[data-id]").each((function(){const e=$(this).attr("data-id");$(this).find("p[data-paxid]").each((function(){const t=$(this).attr("data-paxid");e&&t&&a.push({ruta_id:e,pasajero_id:t})}))})),a}async function consecutivoLineID(){const a=[];gridApi.forEachNode(e=>a.push(e.data));let e=0;a.forEach(a=>{a.line_id&&a.line_id>e&&(e=a.line_id)});return e+1||1}async function relRutasPax2(a){a.classList.contains("expanded")||gridApi.forEachNode((function(a){if(a.data.categoria&&"Ruta"==a.data.categoria.nombre){let e=document.createElement("p");e.textContent="Ruta: "+a.data.concepto,e.setAttribute("data-id",a.data.relaciones_id);let t=document.createElement("select");t.name="seleccion-"+a.data.relaciones_id;let o=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),r=document.createElement("option");r.value="",r.textContent="",r.disabled=!0,r.selected=!0,t.appendChild(r),o.forEach(a=>{let e=$("#"+a.id).val(),o=$("#"+a.id).data("pax"),r=document.createElement("option");r.value=e,r.textContent=e,r.textContent=e,r.setAttribute("data-pax",o),t.appendChild(r),t.appendChild(r)});let i={};t.addEventListener("change",(function(){let a=t.value,o=t.options[t.selectedIndex].getAttribute("data-pax"),r=e.getAttribute("data-id");if(i[r]||(i[r]=[]),i[r].includes(o))return console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!"),void(t.value="");i[r].push(o);let n=document.createElement("p");n.textContent="Pasajero: "+a,n.setAttribute("data-paxid",o),e.insertBefore(n,t)})),e.appendChild(t),document.getElementById("formRelRuta").appendChild(e)}}))}async function relRutasPaxOld(a,e){if(a.classList.contains("expanded"))return;let t=(await obtenerRutPaxCot($("#cotizar_id").val())).reduce((a,e)=>(a[e.ruta_id]||(a[e.ruta_id]=[]),a[e.ruta_id].push(e),a),{});console.log(t);let o={};gridApi.forEachNode((function(a){if(a.data.categoria&&"Ruta"==a.data.categoria.nombre){let e=document.createElement("p");e.textContent="Ruta: "+a.data.concepto,e.classList.add("rel-ruta"),e.setAttribute("data-id",a.data.cot_det_id);let r=document.createElement("select");r.name="seleccion-"+a.data.cot_det_id;let i=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),n=document.createElement("option");n.value="",n.textContent="Agrega un pasajero",n.disabled=!0,n.selected=!0,r.appendChild(n),i.forEach(a=>{let e=$("#"+a.id).val(),t=$("#"+a.id).data("pax"),o=document.createElement("option");o.value=e,o.textContent=e,o.setAttribute("data-pax",t),r.appendChild(o)}),r.addEventListener("change",(function(){let a=r.value,t=r.options[r.selectedIndex].getAttribute("data-pax"),i=e.getAttribute("data-id");if(o[i]||(o[i]=[]),o[i].includes(t))return console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!"),void(r.value="");o[i].push(t);let n=document.createElement("p");n.textContent="Pasajero: "+a,n.setAttribute("data-paxid",t),e.insertBefore(n,r),r.value=""})),e.appendChild(r),document.getElementById("formRelRuta").appendChild(e),t[a.data.cot_det_id]&&t[a.data.cot_det_id].forEach(t=>{let i=document.createElement("p");i.textContent="Pasajero: "+t.nombre,i.setAttribute("data-paxid",t.pasajero_id),e.insertBefore(i,r);let n=Array.from(r.options).find(a=>a.getAttribute("data-pax")==t.pasajero_id);n&&(n.selected=!0),o[a.data.cot_det_id]||(o[a.data.cot_det_id.toString()]=[]),o[a.data.cot_det_id].push(t.pasajero_id.toString())})}}))}async function relRutasPax(a,e){if(a.classList.contains("expanded"))return;let t=(await obtenerRutPaxCot($("#cotizar_id").val())).reduce((a,e)=>(a[e.ruta_id]||(a[e.ruta_id]=[]),a[e.ruta_id].push(e),a),{}),o={};gridApi.forEachNode((function(a){if(a.data.categoria&&"Ruta"===a.data.categoria.nombre){let e=document.createElement("p");e.textContent="Ruta: "+a.data.concepto,e.classList.add("rel-ruta"),e.setAttribute("data-id",a.data.line_id);let r=document.createElement("select");r.name="seleccion-"+a.data.line_id;let i=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),n=document.createElement("option");n.value="",n.textContent="Agrega un pasajero",n.disabled=!0,n.selected=!0,r.appendChild(n),i.forEach(a=>{let e=a.value,t=a.getAttribute("data-pax"),o=document.createElement("option");o.value=t,o.textContent=e,r.appendChild(o)}),r.addEventListener("change",(function(){let a=r.value,t=r.options[r.selectedIndex].textContent,i=e.getAttribute("data-id");if(o[i]||(o[i]=[]),o[i].includes(a))return console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!"),void(r.value="");o[i].push(a);let n=document.createElement("p");n.textContent="Pasajero: "+t,n.setAttribute("data-paxid",a),e.insertBefore(n,r),r.value=""})),e.appendChild(r),document.getElementById("formRelRuta").appendChild(e),t[a.data.line_id]&&t[a.data.line_id].forEach(t=>{let i=document.createElement("p");i.textContent="Pasajero: "+t.nombre,i.setAttribute("data-paxid",t.pasajero_id),e.insertBefore(i,r),o[a.data.line_id]||(o[a.data.line_id]=[]),o[a.data.line_id].push(t.pasajero_id.toString())})}}))}async function obtenerCotizaciones(){try{const a=await fetch("../obtener/cotizaciones",{method:"GET"}),e=await a.json();let t=verificarArray(e);gridApi.setGridOption("rowData",t)}catch(a){console.error(a),SwalToast("warning","Error al obtener las cotizaciones",2500)}}async function obtnerVuelosId(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/vuelos",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function establecerAsientos(){let a=await obtenerAeronaves(),e=$("#aeronave_id").val();const t=a.find(a=>a.aeronave_id==e);t&&(PASAJEROS=t.asientos)}async function validaRutaTarifa(a,e){try{let t=$("#cliente_id").val(),o=$("#broker_id").val();const r=$("#aeronave_id").val(),i=new FormData;i.append("origen",a),i.append("destino",e),i.append("cliente_id",t),i.append("broker_id",o),i.append("aeronave_id",r);const n=await fetch("../valida/ruta",{method:"POST",body:i});return await n.json()}catch(a){console.error(a),SwalToast("warning","Error al obtener los usuarios",2500)}}async function obtenerTarifaCosto(){try{const a=$("#aeronave_id").val(),e=$("#broker_id").val(),t=$("#cliente_id").val(),o=new FormData;o.append("aeronave",a),o.append("broker_id",e),o.append("cliente_id",t);const r=await fetch("../obtener/tarifacostos",{method:"post",body:o}),i=await r.json();i&&i.tarifa&&$("#costo_id").val(i.tarifa.costo_id)}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerPasajeros(){try{const a=await fetch("../obtener/pasajeros",{method:"get"});return await a.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerRutPaxCot(a){try{const e=new FormData;e.append("cotizar_id",a);const t=await fetch("../obtener/rutPaxCot",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerDocsbyPax(a){try{const e=new FormData;e.append("pasajero_id",a);const t=await fetch("../obtener/pasajerosDocs",{method:"POST",body:e});return await t.json()}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function obtenerAeropuertos(){try{const a=await fetch("../allAeropuertos",{method:"GET"}),e=await a.json();return!e.length>0?SwalToast("warning","No hay Aeropuertos disponibles.",2500):AEROPUERTOS=e,e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerTipoCambio(){try{const a=await fetch("../tipo/cambio",{method:"GET"}),e=await a.json();if(e){let a=e.tipo_cambio,t=.01*a,o=parseFloat(a)+parseFloat(t);$("#tipo_cambio option").val(e.tipo_cambio_id),$("#tipo_cambio option").text(parseFloat(o).toFixed(2))}else SwalToast("warning","No hay Tipo de Cambio.",2500);return e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerCategorias(){try{const a=await fetch("../obtener/categorias",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Categorias disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerProductos(){try{const a=await fetch("../obtener/productos",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Productos disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerAeronaves(){try{const a=await fetch("../allAeronaves",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Aeronaves disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerClientes(){try{const a=await fetch("../allClientes",{method:"GET"}),e=await a.json();return!e.length>0&&SwalToast("warning","No hay Clientes disponibles.",2500),e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerEmpresas(){try{const a=await fetch("../brokers/activas",{method:"GET"}),e=await a.json();return!e.length>0?SwalToast("warning","No hay Empresas disponibles.",2500):EMPRESAS=e,e}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerCodigosIATA(a,e){try{const t=new FormData;t.append("origen",a),t.append("destino",e);const o=await fetch("../obtener/codigos",{method:"POST",body:t});return await o.json()}catch(a){console.error(a),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerTasaAterrizaje(a,e){try{const t=new FormData;t.append("origen",a),t.append("aeronave_id",e);const o=await fetch("../valida/aterrizaje",{method:"POST",body:t});return await o.json()}catch(a){console.error(a),SwalToast("warning","Error al obtener los usuarios",2500)}}async function obtenerCotizacionPDF(){try{const a=new FormData,e=$("#fecha-cot").val(),t=$("#folio").val(),o=$("#aeronave_id").val();if(1==$("#slctOpcion").val()){const e=$("#cliente_id").val(),t=$("#cliente_id option").text();a.append("cliente_id",e),a.append("clienteName",t)}else if(2==$("#slctOpcion").val()){const e=$("#broker_id").val(),t=$("#broker_id option").text();a.append("broker_id",e),a.append("brokerName",t)}const r="Contado",i=$("#subtotal").val(),n=$("#ivaNac").val(),d=$("#ivaInt").val(),c=$("#total").val(),l=$("#cant_pernocta").val(),s=$("#tot_pernocta").val(),p=$("#cant_hrs").val(),u=$("#tot_hrs").val();let m=await validarGridPDF();m.length>0&&m.forEach(a=>{a.categoria&&"Ruta"!=a.categoria&&delete a.fecha_salida}),a.append("fecha_cot",e),a.append("folio",t),a.append("aeronave_id",o),a.append("condiciones",r),a.append("subtotal",i),a.append("ivaNac",n),a.append("ivaInt",d),a.append("total",c),a.append("cant_pernocta",l),a.append("tot_pernocta",s),a.append("cant_hrs",p),a.append("tot_hrs",u),a.append("detalles",JSON.stringify(m));const f=await fetch("../obtener/pdf",{method:"POST",body:a}),h=await f.json();h.urlArchivo?window.open(h.urlArchivo,"_blank"):console.error("No se pudo obtener la URL del archivo PDF.")}catch(a){console.error(a),SwalToast("warning","Error al obtener el PDF",2500)}}async function validarDetEliminar(a,e){if("Ruta"===e.data.categoria.nombre){$("#aeronave_id").val();gridApi.forEachNode(async e=>{const t=e.data,o=e;t.categoria&&"Pernocta"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id)),t.categoria&&"Tua"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id)),t.categoria&&"Aterrizaje"===t.categoria.nombre&&t.rel_ruta===a&&(limpiarCelda(o),await eliminarDet(t.cot_det_id))})}await eliminarDet(e.data.cot_det_id),limpiarCelda(e)}async function crearCotizacion(){try{const a=new FormData,e=$("#aeronave_id").val(),t=$("#fecha-cot").val(),o=$("#estatus").val();if(1==$("#slctOpcion").val()){const e=$("#cliente_id").val();a.append("cliente_id",e)}else if(2==$("#slctOpcion").val()){const e=$("#broker_id").val();a.append("broker_id",e)}const r=$("#tipo_cambio").val(),i=$("#cant_pernocta").val(),n=sinComa($("#tot_pernocta").val()),d=sinComa($("#tot_hrs").val()),c=sinComa($("#subtotal").val()),l=sinComa($("#ivaNac").val()),s=sinComa($("#ivaInt").val()),p=sinComa($("#total").val()),u=$("#costo_id").val(),m=$("#rt-comment").val();let f=0,h=await validarGrid(),_=await validarPasajeros();if(h.length>0){let g=h[0].origen,v=h[0].destino;if(1==h.length)f=1;else if(2==h.length){let a=h[1].origen;f=g==h[1].destino&&v==a?2:3}else f=3;a.append("aeronave_id",e),a.append("fechaCot",t),a.append("estatus",o),a.append("tipo_cambio_id",r),a.append("cant_pernocta",i),a.append("tot_pernocta",n),a.append("tot_hr_cotizadas",d),a.append("subtotal",c),a.append("ivaNac",l),a.append("ivaInt",s),a.append("total",p),a.append("tipo_de_viaje",f),a.append("costo_id",u),a.append("comentarios",m),a.append("pasajerosDet",JSON.stringify(_)),a.append("detalles",JSON.stringify(h)),_.forEach((e,t)=>{if(e&&e.nombre){let t;e.pasajero_id?(t=e.pasajero_id,a.append("archivo_"+t,e.nombre_ruta)):(t=e.nombre.split(" ").map(a=>a.charAt(0)).join(""),a.append("archivo_"+t,e.nombre_ruta))}});const b=await fetch("../crear/costeo",{method:"POST",body:a}),w=await b.json();if(1==w.exito?(SwalLoad("success","Éxito","Registro Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==w.exito&&SwalLoad("error","Error en la Transacción",w.errorSMS,!0),w.alertas)return void SwalToast("warning",w.alertas.error,2500)}}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarCotizacion(){try{const a=new FormData,e=$("#cotizar_id").val(),t=$("#folio").val(),o=$("#estatus").val(),r=$("#fecha-cot").val(),i=$("#aeronave_id").val();if(1==$("#slctOpcion").val()){const e=$("#cliente_id").val();a.append("cliente_id",e)}else if(2==$("#slctOpcion").val()){const e=$("#broker_id").val();a.append("broker_id",e)}const n=$("#tipo_cambio").val(),d=$("#cant_pernocta").val(),c=sinComa($("#tot_pernocta").val()),l=sinComa($("#tot_hrs").val()),s=sinComa($("#subtotal").val()),p=sinComa($("#ivaNac").val()),u=sinComa($("#ivaInt").val()),m=sinComa($("#total").val()),f=$("#costo_id").val(),h=$("#rt-comment").val(),_=document.querySelector('meta[name="csrf-token"]').getAttribute("content");let g=0,v=await validarGrid(),b=await validarPasajeros();if(v.length>0){let w=v[0].origen,C=v[0].destino;if(1==v.length)g=1;else if(2==v.length){let a=v[1].origen;g=w==v[1].destino&&C==a?2:3}else g=3;a.append("cotizar_id",e),a.append("folio_cotizar",t),a.append("aeronave_id",i),a.append("fecha_creacion",r),a.append("estatus",o),a.append("tipo_cambio_id",n),a.append("cant_pernocta",d),a.append("tot_pernocta",c),a.append("tot_hr_cotizadas",l),a.append("subtotal",s),a.append("ivaNac",p),a.append("ivaInt",u),a.append("total",m),a.append("comentarios",h),a.append("tipo_de_viaje",g),a.append("costo_id",f),a.append("pasajerosDet",JSON.stringify(b)),a.append("detalles",JSON.stringify(v)),a.append("csrf_token",_),b.forEach((e,t)=>{if(e&&e.nombre&&e.nombre_ruta){let t;e.pasajero_id?(t=e.pasajero_id,a.append("archivo_"+t,e.nombre_ruta)):(t=e.nombre.split(" ").map(a=>a.charAt(0)).join(""),a.append("archivo_"+t,e.nombre_ruta))}});const E=await fetch("../actualizar/costeo",{method:"POST",body:a,headers:{"X-CSRF-Token":_}}),$=await E.json();if(1==$.exito?(SwalLoad("success","Éxito","Registro Actualizado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==$.exito&&SwalLoad("error","Error en la Transacción",$.errorSMS,!0),$.alertas)return void SwalToast("warning",$.alertas.error,2500)}}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarRutaPax(){try{let a=await validarRutaPax();if(""==a)return;const e=$("#cotizar_id").val(),t=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),o=new FormData;o.append("id_cot",e),o.append("relRutaPax",JSON.stringify(a)),o.append("csrf_token",t);const r=await fetch("../actualizar/relacionRutaPax",{method:"POST",body:o,headers:{"X-CSRF-Token":t}}),i=await r.json();console.log(i),$("#formRelRuta").empty()}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function eliminarDet(a){try{const e=$("#cotizar_id").val(),t=new FormData;t.append("cot_det_id",a),t.append("cotizar_id",e);const o=await fetch("../eliminar/detalle",{method:"POST",body:t}),r=await o.json();if(1==r.exito&&SwalToast("success","Registro Eliminado Correctamente",2500),r.alertas)return void SwalToast("warning",r.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function eliminarPasajero(a,e){try{const t=new FormData;t.append("cotizar_id",a),t.append("pasajero_id",e);const o=await fetch("../eliminar/pasajero",{method:"POST",body:t}),r=await o.json();if(1==r.exito&&SwalToast("success","Registro Eliminado Correctamente",2500),r.alertas)return void SwalToast("warning",r.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function generarServicio(){try{const a=$("#cotizar_id").val(),e=new FormData;e.append("cotizar_id",a);const t=await fetch("../generar/servicio",{method:"POST",body:e}),o=await t.json();if(1==o.exito?(SwalLoad("success","Éxito","Servicio Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==o.exito&&SwalLoad("error","Error en la Transacción",o.errorSMS,!0),o.alertas)return void SwalToast("warning",o.alertas.error,2500)}catch(a){console.error(a),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}$((function(){asignarEventos(),inicializarPagina(),configurarBotones()}));class CustomHeaderGroup{init(a){this.params=a,this.eGui=document.createElement("div"),this.eGui.className="ag-header-group-cell-label",this.eGui.innerHTML='<div class="customHeaderLabel">'+this.params.displayName+'</div><div class="customExpandButton"><i class="fa fa-arrow-right"></i></div>',this.onExpandButtonClickedListener=this.expandOrCollapse.bind(this),this.eExpandButton=this.eGui.querySelector(".customExpandButton"),this.eExpandButton.addEventListener("click",this.onExpandButtonClickedListener),this.onExpandChangedListener=this.syncExpandButtons.bind(this),this.params.columnGroup.getProvidedColumnGroup().addEventListener("expandedChanged",this.onExpandChangedListener),this.syncExpandButtons()}getGui(){return this.eGui}expandOrCollapse(){var a=this.params.columnGroup.getProvidedColumnGroup().isExpanded();this.params.setExpanded(!a)}syncExpandButtons(){var a,e;this.params.columnGroup.getProvidedColumnGroup().isExpanded()?(e=this.eExpandButton).className=e.className.split(" ")[0]+" expanded":(a=this.eExpandButton).className=a.className.split(" ")[0]+" collapsed"}destroy(){this.eExpandButton.removeEventListener("click",this.onExpandButtonClickedListener)}}
//# sourceMappingURL=costeo.js.map
