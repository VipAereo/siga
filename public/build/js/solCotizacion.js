let gridOptions,currentStep=1,AEROPUERTOS=[],BROKERS=[],maxId=0;function asignarEventos(){$(".contenedor-altas").hide(),$("#costeo-relacion").hide(),$(".paxSearch").hide(),$(".aeroSearch").hide(),$(".emprSearch").hide(),$(".cliSearch").hide(),$(".origSearch1").hide(),$(".destSearch1").hide(),$(".origSearchIda").hide(),$(".destSearchIda").hide(),$(".origSearchVue").hide(),$(".destSearchVue").hide(),$(".origSchMul1").hide(),$(".destSrchMul1").hide(),$("#inpEmpresa").hide(),aplicarMascaraCantidad("subtotal","ivaNac","ivaInt","total","cant_pernocta","tot_pernocta","cant_hrs","tot_hrs"),document.addEventListener("keydown",e=>{"Escape"===e.key&&resetForm()}),document.getElementById("aeronave_id").addEventListener("mousedown",(async function(e){e.preventDefault(),$(".aeroSearch").show(),$(".inAeroSrch").focus();let a=await obtenerAeronaves();const t=await mostrarListaSearch(a,".aeroSearch","aeronave_id","modelo");t&&(activarRutas(),updateActiveClass()),$(".pax").each((function(){$(this).attr("max",t.asientos),$(this).attr("min","0"),$(".pax").prop("disabled",!1)}))})),document.getElementById("pasajero_id").addEventListener("mousedown",(async function(e){e.preventDefault(),$(".paxSearch").show(),$(".inPaxSrch").focus();let a=await obtenerPasajeros();const t=await mostrarListaSearch(a,".paxSearch","pasajero_id","nombre",!0);"nuevo"==t?($("#pasajero_id option").val(),$("#pasajero_id option").text(""),nuevoPax()):($("#pasajero_id option").val(),$("#pasajero_id option").text(""),setPaxId(t))})),document.getElementById("broker_id").addEventListener("mousedown",(async function(e){e.preventDefault(),$(".emprSearch").show(),$(".inEmprSrch").focus();let a=await obtenerBroker();const t=await mostrarListaSearch(a,".emprSearch","broker_id","nombre");t&&(activarRutas(),updateActiveClass()),$("#rt-responsable").val(t.contacto_principal)})),document.getElementById("cliente_id").addEventListener("mousedown",(async function(e){e.preventDefault(),$(".cliSearch").show(),$(".inCliSrch").focus();let a=await obtenerClientes();await mostrarListaSearch(a,".cliSearch","cliente_id","nombre")&&(activarRutas(),updateActiveClass())})),document.getElementById("slctOpcion").addEventListener("change",(async function(e){mostrarClienteBroker(e.target.value)})),document.getElementById("rt-origen1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".origSearch1").show(),$(".inOrigSrch1").focus();if(await mostrarListaSearch(AEROPUERTOS,".origSearch1","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-destino1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".destSearch1").show(),$(".inDestgSrch1").focus();if(await mostrarListaSearch(AEROPUERTOS,".destSearch1","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-origIda1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".origSearchIda").show(),$(".inOrigSrchIda").focus();if(await mostrarListaSearch(AEROPUERTOS,".origSearchIda","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-destVue1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".destSearchIda").show(),$(".inDestSrchIda").focus();if(await mostrarListaSearch(AEROPUERTOS,".destSearchIda","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-origIda2").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".origSearchVue").show(),$(".inOrigSrchVue").focus();if(await mostrarListaSearch(AEROPUERTOS,".origSearchVue","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-destVue2").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".destSearchVue").show(),$(".inDestSrchVue").focus();if(await mostrarListaSearch(AEROPUERTOS,".destSearchVue","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-origMul1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".origSchMul1").show(),$(".inOrigSrchMul1").focus();if(await mostrarListaSearch(AEROPUERTOS,".origSchMul1","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("rt-destinoMul1").addEventListener("mousedown",(async function(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}$(".destSrchMul1").show(),$(".inDestgSrchMul1").focus();if(await mostrarListaSearch(AEROPUERTOS,".destSrchMul1","aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}})),document.getElementById("btnAddVuelo").addEventListener("click",(function(){nuevaRuta()}));const e=document.querySelector(".toggle-pax"),a=document.querySelector(".toggle-pax-cont");e.addEventListener("click",(function(){a.classList.contains("expanded")?(a.classList.remove("expanded"),e.classList.remove("expanded"),$("#formPasajeros").addClass("toggle-pax-cont")):(a.classList.add("expanded"),e.classList.add("expanded"),$("#formPasajeros").removeClass("toggle-pax-cont"))}));const t=document.querySelector(".toggle-relRuta"),o=document.querySelector(".toggle-relRuta-cont");t.addEventListener("click",(async function(){o.classList.contains("expanded")?(o.classList.remove("expanded"),t.classList.remove("expanded"),$("#formRelRuta").empty()):(o.classList.add("expanded"),t.classList.add("expanded"))}));const r=document.querySelector(".toggle-relRuta");r.addEventListener("mousedown",(async function(){await relRutasPax(r)})),$(".pax").prop("disabled",!0),$("select[name^='rt-orig'], select[name^='rt-dest']").prop("disabled",!0),$(".pax").on("input",(function(){const e=parseInt($(this).attr("max"));parseInt($(this).val())>e&&$(this).val(e)}))}function configurarBotones(){$("#crear-solCot").click((function(){mostrarContenedorAltas("PND")})),$(".nav-destinos button").click((function(e){e.preventDefault();let a=$(this).index()+1;currentStep=a,$("#dest1, #dest2, #dest3").hide(),$("#dest"+a).show(),limpiarForm("#fdest"+a),updateActiveClass()})),$("#btnGuardar").click(async e=>{validateInputs($("#formAltas"))&&""==$("#cotizar_id").val()?await crearCotizacion():(await actualizarCotizacion(),await actualizarRutaPax())}),$("#btnCancel").click(e=>{resetForm()}),$("#btnPasajero").click(e=>{nuevoPax()}),$("#genera_pdf").click(e=>{$("#cotizar_id").val()&&obtenerCotizacionPDF()}),$("#btnServicio").click(e=>{$("#cotizar_id").val()&&generarServicio()}),updateActiveClass()}function inicializarPagina(){setFechaActual("fecha-cot");iniciarTabla("",[{headerName:"id",field:"cotizar_id",width:80},{headerName:"Folio",field:"folio_cotizar",width:80},{headerName:"Broker",field:"nombreBrok",width:110},{headerName:"Cliente",field:"nombreCli",width:110},{headerName:"Aeronave",field:"modeloAeronave",width:160},{headerName:"Ruta",field:"concepto",width:180},{headerName:"Fecha Salida",field:"fecha_salida",width:100},{headerName:"Total",field:"total",width:120,cellStyle:{textAlign:"right"},valueFormatter:function(e){return Number(e.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Estatus",field:"estatus",width:80},{headerName:"Acción",cellRenderer:function(e){const a=document.createElement("I");a.className="fa-regular fa-pen-to-square btn btn-editar",a.title="Editar",a.addEventListener("click",(async function(){let a=e.data.estatus;if(await mostrarContenedorAltas(a),$("#cotizar_id").val(e.data.cotizar_id),$("#folio").val(e.data.folio_cotizar),$("#fecha-cot").val(formatearFechaCompleta(e.data.fecha_creacion)),$("#rt-comment").val(e.data.comentarios),$("#cot-comment").val(e.data.comentarios),$("#estatus").val(e.data.estatus),$("#aeronave_id option").val(e.data.aeronave_id),$("#aeronave_id option").text(e.data.modeloAeronave),$("#tipo_cambio option").val(e.data.tipo_cambio_id),$("#tipo_cambio option").text(Number(e.data.tipo_cambio).toFixed(2)),e.data.cliente_id)mostrarClienteBroker(1),$("#slctOpcion").val(1),$("#cliente_id option").val(e.data.cliente_id),$("#cliente_id option").text(e.data.nombreCli);else if(e.data.broker_id){mostrarClienteBroker(2),$("#slctOpcion").val(2),$("#broker_id option").val(e.data.broker_id),$("#broker_id option").text(e.data.nombreEmpr);const a=(await obtenerBroker()).find(a=>a.broker_id==e.data.broker_id);$("#broker_id option").val(a.broker_id),$("#broker_id option").text(a.nombre),$("#rt-responsable").val(a.contacto_principal)}$(".nav-destinos button").addClass("event-none");let t,o=e.data.tipo_de_viaje;if(document.querySelector(".nav-destinos .pasoActivo").classList.remove("pasoActivo"),1==o?(t=1,document.querySelector(".nav-destinos button:first-child").classList.add("pasoActivo")):2==o?(t=2,document.querySelector(".nav-destinos button:nth-child(2)").classList.add("pasoActivo")):3==o&&(t=3,document.querySelector(".nav-destinos button:last-child").classList.add("pasoActivo")),currentStep=t,$("#dest1, #dest2, #dest3").hide(),$("#dest"+t).show(),"PND"==e.data.estatus){let a=await obtnerVuelosId(e.data.cotizar_id);if(2==t||3==t){const e={2:"cot-detIda",3:"cot-detMul"}[t]||"",o={2:"rt-fechaIda",3:"rt-fechaMul"}[t]||"",r={2:"rt-horaIda",3:"rt-horaMul"}[t]||"",n={2:"rt-paxIda",3:"rt-paxMul"}[t]||"",i={2:"rt-origIda",3:"rt-origMul"}[t]||"",c={2:"rt-destVue",3:"rt-destinoMul"}[t]||"";for(let e=1;e<a.length;e++)nuevaRuta();const d=document.querySelectorAll(`#fdest${t} .nuevaRuta`);d.length==a.length&&d.forEach((t,d)=>{const s=a[d].cot_det_id,l=a[d].fecha_salida,u=a[d].hora_salida,p=a[d].pasajeros,m=a[d].origenId,h=a[d].origMun,f=a[d].destinoId,v=a[d].destMun,g=document.querySelector(`#${e}${d+1}`),$=t.querySelector(`#${o}${d+1}`),_=t.querySelector(`#${r}${d+1}`),w=t.querySelector(`#${n}${d+1}`),b=t.querySelector(`#${i}${d+1} option`),S=t.querySelector(`#${c}${d+1} option`);g.value=s,$.value=l,_.value=u,w.value=p,b.value=m,b.text=h,S.value=f,S.text=v})}else if(1==t&&a.length>0){const e=a[0].cot_det_id,t=a[0].fecha_salida,o=a[0].hora_salida,r=a[0].pasajeros,n=a[0].origenId,i=a[0].origMun,c=a[0].destinoId,d=a[0].destMun,s=document.querySelector("#cot-det1"),l=document.querySelector("#rt-fecha1"),u=document.querySelector("#rt-hora1"),p=document.querySelector("#rt-pax1"),m=document.querySelector("#rt-origen1 option"),h=document.querySelector("#rt-destino1 option");s.value=e,l.value=t,u.value=o,p.value=r,m.value=n,m.text=i,h.value=c,h.text=d}}let r=await obtenerPax(e.data.cotizar_id);detallePax=r.pasajeros;let n=r.paxDoc;for(let e=0;e<detallePax.length;e++)nuevoPax();const i=document.querySelectorAll("#formPasajeros .cont-pasajero");i.length==detallePax.length&&i.forEach((e,a)=>{const t=detallePax[a].pasajero_id,o=detallePax[a].nombre,r=e.querySelector("#paxName"+(a+1));if(r.value=o,r.dataset.pax=t,n){const a=function(e){return n[e]?Array.isArray(n[e])?n[e]:[n[e]]:[]}(t),o=e.querySelector(".contenedor-docs");a.forEach(e=>{const a=document.createElement("a");a.classList.add("thumbnail"),a.href=`/${e.ruta}/${e.hash_doc}.${e.tipo_doc}`,a.setAttribute("target","_blank");const t=document.createElement("DIV");t.classList.add("fileicon");const r=document.createElement("I");r.classList.add("fa-regular","fa-file");const n=document.createElement("DIV");n.classList.add("filename");const i=document.createElement("P");i.textContent=""+e.nombre_doc,t.appendChild(r),n.appendChild(i),a.appendChild(t),a.appendChild(n),o.appendChild(a)})}}),activarRutas(),await activarSecciones()}));const t=document.createElement("div");return t.classList="btn-cont centrado",t.appendChild(a),$(".pax").prop("disabled",!1),t},width:150,headerClass:"txt-center",cellClass:"custom-action-cell",filter:!1}],"#myGrid"),obtenerCotizaciones(),mostrarClienteBroker(1)}async function resetForm(){resetearTabla("#myGrid2","#searchInput1"),cerrarVentana(".contenedor-altas",["#formAltas"]),$(".nav-destinos button").removeClass("event-none"),$("#rt-comment").val(""),$("#inpCliente").hide(),$("#inpEmpresa").hide(),$("#estatus").val(""),setFechaActual("fecha-cot"),currentStep=1,maxId=0,updateActiveClass(),$(".ruta-origen").removeClass("disabled-element"),$("#formRelRuta").empty(),$("#dest1, #dest2, #dest3").hide(),$("#dest"+currentStep).show(),$("select[name^='rt-orig'], select[name^='rt-dest']").prop("disabled",!0);const e=document.querySelectorAll("#formPasajeros .cont-pasajero");for(let a=0;a<e.length;a++)e[a].remove()}async function mostrarContenedorAltas(e){mostrarClienteBroker(1),"PND"!=e?($("#contenedor").addClass("contenedor--lg"),$("#contenedor").removeClass("contenedor--md"),$("#cont-comment").hide(),$("#formTotales").show()):($("#contenedor").removeClass("contenedor--lg"),$("#contenedor").addClass("contenedor--md"),$("#cont-comment").show(),$("#formTotales").hide()),$(".contenedor-altas").show(),await activarSecciones()}function activarRutas(){let e=$("#aeronave_id").val(),a=$("#cliente_id").val(),t=$("#broker_id").val(),o=""!=e,r=""!=a||""!=t;$("select[name^='rt-orig'], select[name^='rt-dest']").prop("disabled",!(o&&r))}async function activarSecciones(){await deshabilitarElemento("cont-encabezado","cont-navegacion","cont-rutas","cont-detalle","costeo-pasajeros","costeo-relacion");let e=$("#estatus").val();$("#btnServicio").hide(),$("#costeo-relacion").hide(),e?"PND"==e?($(".ruta-origen").addClass("disabled-element"),await habilitarElemento("cont-navegacion","cont-rutas"),$("#cont-detalle").hide(),$("#cont-pax").hide()):"CTZ"==e?(habilitarElemento("costeo-pasajeros","cont-detalle","costeo-pasajeros","costeo-relacion"),$("#cont-detalle").show(),$("#cont-pax").show(),$("#cont-navegacion").hide(),$("#cont-rutas").hide(),$("#btnServicio").show(),$("#costeo-pasajeros").show(),$("#costeo-relacion").show()):"SVC"==e?(habilitarElemento("cont-detalle"),$("#cont-detalle").show(),$("#cont-pax").show(),$("#cont-navegacion").hide(),$("#cont-rutas").hide(),$("#costeo-pasajeros").show(),$("#costeo-relacion").show()):"CMP"==e&&(habilitarElemento("cont-detalle"),$("#cont-detalle").show(),$("#cont-pax").show(),$("#cont-navegacion").hide(),$("#cont-rutas").hide(),$("#costeo-pasajeros").show()):($("#cont-navegacion").show(),$("#cont-rutas").show(),$("#cont-detalle").hide(),$("#cont-pax").hide(),$("#costeo-pasajeros").hide(),habilitarElemento("cont-encabezado","cont-navegacion","cont-rutas","cont-comment")),"CTZ"!=e&&"SVC"!=e&&"CMP"!=e||configTablaCrear()}async function configTablaCrear(){let e=await obtenerAeropuertos(),a=[{headerName:"Id",field:"cot_det_id",width:60},{headerName:"Fecha",field:"fecha_salida",width:100,cellEditor:"agDateCellEditor",valueFormatter:function(e){let a=e.value;return a?formatearFecha(a):null}},{headerName:"Hora",field:"hora_salida",width:75,columnGroupShow:"open",valueFormatter:function(e){if(null!==e.value&&void 0!==e.value){const a=e.value;let t=0,o=0;if(a)if(a.includes(":")){const e=a.split(":");t=e[0],o=e[1]}else t=a;else t=a;const r=parseFloat(t),n=parseFloat(o),i=`${r.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`;return/^(0[0-9]|1[0-9]|2[0-3]):([0-5][0-9])$/.test(i)?i:"00:00"}return null}},{headerName:"Categoria",field:"categoria",width:95,cellEditor:"agSelectCellEditor",editable:!1,cellEditorParams:{values:["",...(await obtenerCategorias()).map(e=>({categoria_id:e.categoria_id,nombre:e.nombre}))]},valueFormatter:function(e){if(e.value)return e.value.nombre},valueGetter:function(e){return e.data.categoria?e.data.categoria.nombre:""},valueSetter:function(e){return e.data.categoria=e.newValue,!0}},{headerName:"Concepto",field:"concepto",width:160},{headerName:"Origen",field:"origen",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...e.map(e=>({aeropuerto_id:e.aeropuerto_id,municipio:e.municipio}))]},valueFormatter:function(e){if(e.value)return e.value.municipio},valueGetter:function(e){return e.data.origen?e.data.origen.municipio:""},valueSetter:function(e){return e.data.origen=e.newValue,!0}},{headerName:"Destino",field:"destino",width:120,editable:!1,cellEditor:"agSelectCellEditor",cellEditorParams:{values:["",...e.map(e=>({aeropuerto_id:e.aeropuerto_id,municipio:e.municipio}))]},valueFormatter:function(e){if(e.value)return e.value.municipio},valueParser:function(e){if(e.value)return{aeropuerto_id:e.value.aeropuerto_id,municipio:e.value.municipio}},valueGetter:function(e){return e.data.destino?e.data.destino.municipio:""},cellClassRules:{"event-none":e=>{const a=e.data.cot_det_id;return null!=a&&""!==a}}},{headerName:"pax",field:"pax",width:60},{headerName:"Tipo",field:"tipo_vuelo",width:80,cellEditorParams:{values:["N","I"]},valueFormatter:function(e){const a=e.value;return"I"===a?"Internacional":"N"===a?"Nacional":a}},{headerName:"Cant",field:"cantidad",width:80},{headerName:"Tarifa",field:"tarifa",width:100,editable:!0,cellStyle:{textAlign:"right"},cellEditor:"agNumberCellEditor",valueFormatter:function(e){if(e.value)return Number(e.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Subtotal",field:"subtotal",width:100,cellStyle:{textAlign:"right"},valueFormatter:function(e){if(e.value)return Number(e.value).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",")}},{headerName:"Relacion Ruta",field:"rel_ruta",width:80},{headerName:"Relacion",field:"relaciones_id",width:80},{headerName:"LineID",field:"line_id",width:80}];iniciarTabla("",a,"#myGrid2"),await traerDetalle(),ordenarPorCategoria()}async function updateActiveClass(){$(".nav-destinos button").removeClass("pasoActivo"),$(".dest"+currentStep).addClass("pasoActivo"),await cerrarVentana("",["#fdest1","#fdest2"]),$("#rt-origen1 option").text("Origen"),$("#rt-destino1 option").text("Destino"),$("#rt-origIda1 option").text("Origen"),$("#rt-origIda2 option").text("Destino"),$("#rt-destVue1 option").text("Destino"),$("#rt-destVue2 option").text("Destino");const e=document.querySelectorAll("#fdest3 .nuevaRuta");for(let a=1;a<e.length;a++)e[a].remove();$("#rt-origMul1 option").text("Origen"),$("#rt-destinoMul1 option").text("Destino")}async function obtenerRutPaxCot(e){try{const a=new FormData;a.append("cotizar_id",e);const t=await fetch("../obtener/rutPaxCot",{method:"POST",body:a});return await t.json()}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function relRutasPax(e,a){if(e.classList.contains("expanded"))return;let t=(await obtenerRutPaxCot($("#cotizar_id").val())).reduce((e,a)=>(e[a.ruta_id]||(e[a.ruta_id]=[]),e[a.ruta_id].push(a),e),{}),o={};gridApi.forEachNode((function(e){if(e.data.categoria&&"Ruta"==e.data.categoria.nombre){let a=document.createElement("p");a.textContent="Ruta: "+e.data.concepto,a.classList.add("rel-ruta"),a.setAttribute("data-id",e.data.cot_det_id);let r=document.createElement("select");r.name="seleccion-"+e.data.cot_det_id;let n=document.getElementById("formPasajeros").querySelectorAll(".cont-pasajero [data-pax]"),i=document.createElement("option");i.value="",i.textContent="Agrega un pasajero",i.disabled=!0,i.selected=!0,r.appendChild(i),n.forEach(e=>{let a=$("#"+e.id).val(),t=$("#"+e.id).data("pax"),o=document.createElement("option");o.value=a,o.textContent=a,o.setAttribute("data-pax",t),r.appendChild(o)}),r.addEventListener("change",(function(){let e=r.value,t=r.options[r.selectedIndex].getAttribute("data-pax"),n=a.getAttribute("data-id");if(o[n]||(o[n]=[]),console.log(o),o[n].includes(t))return console.log("¡Este pasajero ya ha sido seleccionado para esta ruta!"),void(r.value="");o[n].push(t);let i=document.createElement("p");i.textContent="Pasajero: "+e,i.setAttribute("data-paxid",t),a.insertBefore(i,r),r.value=""})),a.appendChild(r),document.getElementById("formRelRuta").appendChild(a),t[e.data.cot_det_id]&&(t[e.data.cot_det_id].forEach(t=>{let n=document.createElement("p");n.textContent="Pasajero: "+t.nombre,n.setAttribute("data-paxid",t.pasajero_id),a.insertBefore(n,r);let i=Array.from(r.options).find(e=>e.getAttribute("data-pax")==t.pasajero_id);i&&(i.selected=!0),o[e.data.cot_det_id]||(o[e.data.cot_det_id.toString()]=[]),o[e.data.cot_det_id].push(t.pasajero_id.toString())}),console.log(o))}}))}async function ordenarPorCategoria(){const e=[],a=[],t=[],o=[],r=[];gridApi.forEachNode(n=>{const i=n.data;e.push(i),i.categoria&&("Ruta"==i.categoria.nombre?a.push(i):i.categoria&&"Pernocta"==i.categoria.nombre?o.push(i):i.categoria&&"Aterrizaje"==i.categoria.nombre?t.push(i):r.push(i))});let n=[...a,...o,...t,...r];if(n.push({}),n.length<9){const e=Array(8-n.length).fill({}),a=n.concat(e).map(e=>({...e}));gridApi.updateGridOptions({rowData:a})}else gridApi.updateGridOptions({rowData:n})}async function obtenerCotizaciones(){try{const e=await fetch("../obtener/cotizaciones",{method:"GET"}),a=await e.json();let t=verificarArray(a);gridApi.setGridOption("rowData",t)}catch(e){console.error(e),SwalToast("warning","Error al obtener las Cotizaciones",2500)}}function actTotalesLineold(e){let a=parseFloat(e.tarifa_aterrizaje||0)+parseFloat(e.tarifa_ser_terrestre||0)+parseFloat(e.tarifa_ser_auxiliares||0);e.total_costos=a;const t=parseFloat(e.hora_cotizada||0);let o=parseFloat(e.pernocta||0);const r=parseFloat(e.costo||0);let n=t*r+o*r;n+=a,e.subtotal=n,gridApi.applyTransaction({update:[e]})}function actTotalesLine(e){if(!e)return;const a=e.line_id;gridApi.forEachNode(e=>{if(e.data.line_id===a&&e.data.categoria){const a=e.data.categoria.nombre,t=e.data.percost,o=e.data.cantidad,r=e.data.tarifa;let n=0;n="Ruta"==a?o*r:"Pernocta"==a?o*t*r:"Aterrizaje"==a?r:o*r,e.setDataValue("subtotal",n)}gridApi.refreshCells({force:!0})})}function actTotales(){let e=0,a=0,t=0,o=0,r=0,n=0,i=0,c=0,d=0;gridApi.forEachNode(c=>{const d=parseFloat(c.data.cantidad||0),s=parseFloat(c.data.subtotal||0);c.data.categoria&&"Pernocta"==c.data.categoria.nombre&&(e+=d,a+=s),c.data.categoria&&"Ruta"==c.data.categoria.nombre&&(t+=d,o+=s),r+=s,"N"==c.data.tipo_vuelo?n+=s:"I"==c.data.tipo_vuelo&&(i+=s)}),c=.16*n,d=.04*i,$("#cant_pernocta").val(e),$("#tot_pernocta").val(a),$("#cant_hrs").val(t),$("#tot_hrs").val(o),$("#subtotal").val(r),$("#ivaNac").val(c),$("#ivaInt").val(d),$("#total").val(r+c+d)}async function obtenerAeronaves(){try{const e=await fetch("../allAeronaves",{method:"GET"}),a=await e.json();return!a.length>0&&SwalToast("warning","No hay Aeronaves disponibles.",2500),a}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerBroker(){try{const e=await fetch("../brokers/activas",{method:"GET"}),a=await e.json();return!a.length>0?SwalToast("warning","No hay Programas disponibles.",2500):BROKERS=a,a}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerClientes(){try{const e=await fetch("../allClientes",{method:"GET"}),a=await e.json();return!a.length>0&&SwalToast("warning","No hay Clientes disponibles.",2500),a}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerAeropuertos(){try{const e=await fetch("../allAeropuertos",{method:"GET"}),a=await e.json();return!a.length>0?SwalToast("warning","No hay Aeropuertos disponibles.",2500):AEROPUERTOS=a,a}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerPax(e){try{const a=new FormData;a.append("cotizar_id",e);const t=await fetch("../obtener/pax",{method:"POST",body:a});return await t.json()}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerPasajeros(){try{const e=await fetch("../obtener/pasajeros",{method:"get"});return await e.json()}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function mostrarListaOrigen(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}let a=$(this).attr("id").replace("rt-origMul","");$(".origSchMul"+a).show(),$(".inOrigSrchMul"+a).focus();if(await mostrarListaSearch(AEROPUERTOS,".origSchMul"+a,"aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}}async function mostrarListaDestino(e){if(e.preventDefault(),""==AEROPUERTOS){await obtenerAeropuertos()}let a=$(this).attr("id").replace("rt-destinoMul","");$(".destSrchMul"+a).show(),$(".inDestgSrchMul"+a).focus();if(await mostrarListaSearch(AEROPUERTOS,".destSrchMul"+a,"aeropuerto_id","municipio")){existeRuta(this.parentNode.parentNode.parentNode),activarRutas()}}function validarRutas(e){let a=!1,t=document.getElementById(e),o=t.querySelectorAll('select, input[type="date"]');return t.querySelectorAll(".errorRuta").forEach((function(e){e.classList.remove("errorRuta")})),o.forEach((function(e){e.value.trim()||("SELECT"==e.tagName?e.parentNode.parentNode.parentNode.classList.add("errorRuta"):"INPUT"==e.tagName&&e.classList.add("errorRuta"),a=!0)})),a}async function obtenerRutas(){let e=$(".nav-destinos").find(".pasoActivo"),a=$(".nav-destinos button").index(e);if(0===a){if(validarRutas("fdest1"))return;let e="#fdest1",a=[];const t=document.querySelectorAll(e+" .nuevaRuta");return await Promise.all(Array.from(t).map(async(e,t)=>{let o=e.querySelector('input[id^="cot-det"]');o=o.getAttribute("id"),o=$("#"+o).val();let r=e.querySelector('select[id^="rt-origen"]').value,n=e.querySelector('select[id^="rt-destino"]').value,i=e.querySelector('input[id^="rt-fecha"]').value,c=e.querySelector('input[id^="rt-pax"]').value,d=e.querySelector('input[id^="rt-hora"]').value,s={line_id:t+1,categoria_id:1,concepto:await obtenerCodigosIATA(r,n),cot_det_id:o,origen:r,destino:n,fecha_salida:i,pasajeros:c,hora_salida:d};a.push(s)})),a}if(1===a){if(validarRutas("fdest2"))return;let e="#fdest2",a=[];const t=document.querySelectorAll(e+" .nuevaRuta");return await Promise.all(Array.from(t).map(async(e,t)=>{let o=e.querySelector('input[id^="cot-detIda"]');o=o.getAttribute("id"),o=$("#"+o).val();let r=e.querySelector('select[id^="rt-origIda"]').value,n=e.querySelector('select[id^="rt-destVue"]').value,i=e.querySelector('input[id^="rt-fechaIda"]').value,c=e.querySelector('input[id^="rt-paxIda"]').value,d=e.querySelector('input[id^="rt-horaIda"]').value,s={line_id:t+1,categoria_id:1,concepto:await obtenerCodigosIATA(r,n),cot_det_id:o,origen:r,destino:n,fecha_salida:i,pasajeros:c,hora_salida:d};a.push(s)})),a}if(2===a){if(validarRutas("fdest3"))return;let e="#fdest3",a=[];const t=document.querySelectorAll(e+" .nuevaRuta");return await Promise.all(Array.from(t).map(async(e,t)=>{let o=e.querySelector('input[id^="cot-detMul"]');o=o.getAttribute("id"),o=$("#"+o).val();let r=e.querySelector('select[id^="rt-origMul"]').value,n=e.querySelector('select[id^="rt-destinoMul"]').value,i=e.querySelector('input[id^="rt-fechaMul"]').value,c=e.querySelector('input[id^="rt-paxMul"]').value,d=e.querySelector('input[id^="rt-horaMul"]').value,s={line_id:t+1,categoria_id:1,concepto:await obtenerCodigosIATA(r,n),cot_det_id:o,origen:r,destino:n,fecha_salida:i,pasajeros:c,hora_salida:d};a.push(s)})),a}}async function obtenerDocsbyPax(e){try{const a=new FormData;a.append("pasajero_id",e);const t=await fetch("../obtener/pasajerosDocs",{method:"POST",body:a});return await t.json()}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function obtnerVuelosId(e){try{const a=new FormData;a.append("cotizar_id",e);const t=await fetch("../obtener/vuelos",{method:"POST",body:a});return await t.json()}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function obtenerTasaAterrizaje(e,a){try{const t=new FormData;t.append("origen",e),t.append("aeronave_id",a);const o=await fetch("../valida/aterrizaje",{method:"POST",body:t});return await o.json()}catch(e){console.error(e),SwalToast("warning","Error al obtener los usuarios",2500)}}async function obtenerCategorias(){try{const e=await fetch("../obtener/categorias",{method:"GET"}),a=await e.json();return!a.length>0&&SwalToast("warning","No hay Categorias disponibles.",2500),a}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function validaRutaTarifa(e,a){try{let t=$("#cliente_id").val(),o=$("#broker_id").val();const r=$("#aeronave_id").val(),n=new FormData;n.append("origen",e),n.append("destino",a),n.append("cliente_id",t),n.append("broker_id",o),n.append("aeronave_id",r);const i=await fetch("../valida/ruta",{method:"POST",body:n});return await i.json()}catch(e){console.error(e),SwalToast("warning","Error al obtener los usuarios",2500)}}function mostrarClienteBroker(e){$("#inpCliente").toggle(1==e),$("#inpEmpresa").toggle(2==e),1==e?($("label[for='cliente_id']").addClass("labelImportant"),$("label[for='broker_id']").removeClass("labelImportant"),$("select[id='broker_id'] option").val(""),$("select[id='broker_id'] option").text("")):2==e&&($("label[for='broker_id']").addClass("labelImportant"),$("label[for='cliente_id']").removeClass("labelImportant"),$("#rt-responsable").val(""),$("select[id='cliente_id'] option").val(""),$("select[id='cliente_id'] option").text(""))}function nuevaRuta(){let e=document.getElementById("fdest3").querySelectorAll(".ruta-origen").length;e>maxId&&(maxId=e);let a=maxId+1;maxId=a;let t=document.createElement("div");t.classList.add("row","gap-1","nuevaRuta"),t.innerHTML=`\n        <div class="col-7">\n            <input type="text" id="cot-detMul${a}" class="hidden">\n            <p>Ruta <span>${a}</span></p>\n            <div class="row ruta-origen hr_separador">\n                <div class="col-6 listados">\n                    <div class="vuelo-titulo">\n                        <select name="rt-origMul${a}" id="rt-origMul${a}" placeholder="">\n                            <option value="">Origen</option>\n                        </select>\n                    </div>\n                    <i class="vuelo-icon fa-solid fa-plane-departure"></i>\n                    <div class="containerSearch origSchMul${a}">\n                        <input placeholder="Buscar..." class="inOrigSrchMul${a}" type="search" name="inOrigSrchMul${a}">\n                        <i class="fa-solid fa-magnifying-glass"></i>\n                    </div>\n                </div>\n                <div class="separador-icon">\n                    <i class=" fa-solid fa-arrow-right"></i>\n                </div>\n                <div class="col-6 listados">\n                    <div class="vuelo-titulo">\n                        <select name="rt-destinoMul${a}" id="rt-destinoMul${a}" placeholder="">\n                            <option value="">Destino</option>\n                        </select>\n                    </div>\n                    <i class="vuelo-icon fa-solid fa-plane-arrival"></i>\n                    <div class="containerSearch destSrchMul${a}">\n                        <input placeholder="Buscar..." class="inDestgSrchMul${a}" type="search" name="inDestgSrchMul${a}">\n                        <i class="fa-solid fa-magnifying-glass"></i>\n                    </div>\n                </div>\n            </div>\n            <a class="btn btn-eliminarRuta" id="eliminarRuta${a}">Eliminar ruta</a>\n        </div>\n        <div class="col-5 row gap-1">\n\n            <div class="rt-fecha">\n                <label for="rt-fechaMul${a}">Fecha</label>\n                <input type="date" id="rt-fechaMul${a}" />\n            </div>\n            <div class="rt-hora">\n                <label for="rt-horaMul${a}">Hora:</label>\n                <input type="time" name="rt-horaMul${a}" id="rt-horaMul${a}">\n            </div>\n            <div class="rt-pax">\n                <label for="rt-paxMul${a}">Pax</label>\n                <input class="pax" type="number" name="" id="rt-paxMul${a}" min="0" placeholder="0">\n            </div>\n        </div>\n    `,document.getElementById("fdest3").appendChild(t),$(".origSchMul"+a).hide(),$(".destSrchMul"+a).hide(),$("#rt-origMul"+a).on("mousedown",mostrarListaOrigen),$("#rt-destinoMul"+a).on("mousedown",mostrarListaDestino),$("select[name^='rt-orig'], select[name^='rt-dest']").prop("disabled",!0),activarRutas(),$("#eliminarRuta"+a).on("click",(function(){const e=$("#cotizar_id").val(),t=$("#cot-detMul"+a).val();t&&e&&eliminarRuta(e,t),$(this).closest(".nuevaRuta").remove()}))}function nuevoPax(){const e=document.getElementById("formPasajeros");document.getElementById("btnPasajero");let a=e.querySelectorAll(".cont-pasajero").length+1;const t=document.createElement("DIV");t.classList.add("cont-form3","cont-pasajero");const o=document.createElement("DIV");o.classList.add("form-group");const r=document.createElement("INPUT");r.type="text",r.id="pasajero_id"+a,r.classList.add("hidden");const n=document.createElement("INPUT");n.type="text",n.id="paxName"+a,n.placeholder="",o.appendChild(n);const i=document.createElement("LABEL");i.textContent="Pasajero "+a+":",i.htmlFor="paxName"+a,o.appendChild(i),t.appendChild(o);const c=document.createElement("DIV");c.classList.add("form-group");const d=document.createElement("INPUT");d.type="file",d.name="paxFile"+a,d.id="paxFile"+a,d.accept="image/*",c.appendChild(d);const s=document.createElement("A");s.id="btnEliminarPax"+a,s.classList.add("btn","btn-eliminarPax"),s.title="Eliminar Pasajero";const l=document.createElement("DIV");l.classList.add("contenedor-docs","flex"),c.appendChild(s),t.appendChild(c),e.appendChild(t),t.appendChild(l),$("#btnEliminarPax"+a).on("click",(async function(){const e=$("#cotizar_id").val(),a=$(this).closest(".cont-pasajero").find('input[id^="paxName"]').data("pax");e&&a&&await eliminarPasajero(e,a),$(this).closest(".cont-pasajero").remove()}))}async function setPaxId(e){let a=0;if(document.querySelectorAll("#formPasajeros .cont-pasajero").forEach((t,o)=>{let r=t.querySelector('input[id^="paxName"]');if(r){(r.dataset.paxn||r.dataset.pax)==e.pasajero_id&&(a=1)}}),0==a){const a=e.pasajero_id,t=await obtenerDocsbyPax(a),o=document.getElementById("formPasajeros");document.getElementById("btnPasajero"),document.getElementById("pasajero_id");let r=o.querySelectorAll(".cont-pasajero").length+1;const n=document.createElement("DIV");n.classList.add("cont-form3","cont-pasajero");const i=document.createElement("DIV");i.classList.add("form-group");const c=document.createElement("INPUT");c.type="text",c.id="pasajero_id"+r,c.classList.add("hidden");const d=document.createElement("INPUT");d.type="text",d.id="paxName"+r,d.placeholder="",d.value=e.nombre,d.setAttribute("data-paxN",a),i.appendChild(d);const s=document.createElement("LABEL");s.textContent="Pasajero "+r+":",s.htmlFor="paxName"+r,i.appendChild(s),n.appendChild(i);const l=document.createElement("DIV");l.classList.add("form-group");const u=document.createElement("INPUT");u.type="file",u.name="paxFile"+r,u.id="paxFile"+r,u.accept="image/*",l.appendChild(u);const p=document.createElement("A");p.id="btnEliminarPax"+r,p.classList.add("btn","btn-eliminarPax"),p.title="Eliminar Pasajero";const m=document.createElement("DIV");m.classList.add("contenedor-docs","flex"),l.appendChild(p),n.appendChild(l),o.appendChild(n),n.appendChild(m),t.length>0&&t.forEach(e=>{const a=document.createElement("a");a.classList.add("thumbnail"),a.href=`/${e.ruta}/${e.hash_doc}.${e.tipo_doc}`,a.setAttribute("target","_blank");const t=document.createElement("DIV");t.classList.add("fileicon");const o=document.createElement("I");o.classList.add("fa-regular","fa-file");const r=document.createElement("DIV");r.classList.add("filename");const n=document.createElement("P");n.textContent=""+e.nombre_doc,t.appendChild(o),r.appendChild(n),a.appendChild(t),a.appendChild(r),m.appendChild(a)}),$("#btnEliminarPax"+r).on("click",(async function(){$("#cotizar_id").val(),$(this).closest(".cont-pasajero").find('input[id^="paxName"]').data("paxn");$(this).closest(".cont-pasajero").remove()}))}}async function validarRutaPax(){const e=[];return $("#formRelRuta").find("p[data-id]").each((function(){const a=$(this).attr("data-id");$(this).find("p[data-paxid]").each((function(){const t=$(this).attr("data-paxid");a&&t&&e.push({ruta_id:a,pasajero_id:t})}))})),e}async function validarPasajeros(){const e=[];return document.querySelectorAll("#formPasajeros .cont-pasajero").forEach((a,t)=>{let o=a.querySelector('input[id^="paxName"]'),r=a.querySelector('input[id^="paxFile"]'),n={};if(o&&""!==o.value.trim()||o&&o.dataset.paxn){let a=o.dataset.pax||o.dataset.paxn;a&&(n.pasajero_id=a.trim()),r&&r.files.length>0&&(n.nombre_ruta=r.files[0]),n.nombre=o.value.trim(),e.push(n)}}),e}async function existeRuta(e){let a=$(e).find("select[name^='rt-orig']").val(),t=$(e).find("select[name^='rt-dest']").val(),o=$("#cliente_id").val(),r=$("#broker_id").val(),n=$("#aeronave_id").val();if(a&&t&&n&&(o||r))try{const i=new FormData;i.append("origen",a),i.append("destino",t),i.append("cliente_id",o),i.append("broker_id",r),i.append("aeronave_id",n);const c=await fetch("../valida/ruta",{method:"POST",body:i}),d=await c.json();"0"==d.exito&&($(e).find("select[name^='rt-orig'] option").val(""),$(e).find("select[name^='rt-orig'] option").text("Origen"),$(e).find("select[name^='rt-dest'] option").val(""),$(e).find("select[name^='rt-dest'] option").text("Destino"),SwalToast("warning",d.alertas.error[0],2500))}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function traerDetalle(){let e=$("#cotizar_id").val(),a=(await obtnerVuelosId(e)).map(e=>{let a={cot_det_id:e.cot_det_id,categoria:{categoria_id:e.categoria_id,nombre:e.nombreCat},fecha_salida:e.fecha_salida,pasajeros:e.pasajeros,tipo_vuelo:e.tipo_vuelo,hora_salida:e.hora_salida,concepto:e.concepto,cantidad:e.cantidad,tarifa:e.tarifa,rel_ruta:e.rel_ruta,relaciones_id:e.relacion_id,line_id:e.line_id,subtotal:e.subtotal};return 1==e.categoria_id&&(a.origen={aeropuerto_id:e.origenId,municipio:e.origMun},a.destino={aeropuerto_id:e.destinoId,municipio:e.destMun}),a});if(a.length<9){const e=Array(8-a.length).fill({}),t=a.concat(e).map(e=>({...e}));gridApi.setGridOption("rowData",t)}else gridApi.setGridOption("rowData",a);$("#aeronave_id").val();let t=[];gridApi.forEachNode(e=>{t.push(e.data)}),actTotales();let o=t.filter(e=>void 0!==e.costo);o.length>0&&gridApi.applyTransaction({update:o}),gridApi.applyTransaction({update:t})}async function obtenerCotizacionPDF(){try{const e=new FormData,a=$("#fecha-cot").val(),t=$("#folio").val(),o=$("#aeronave_id").val();if(1==$("#slctOpcion").val()){const a=$("#cliente_id").val(),t=$("#cliente_id option").text();e.append("cliente_id",a),e.append("clienteName",t)}else if(2==$("#slctOpcion").val()){const a=$("#broker_id").val(),t=$("#broker_id option").text();e.append("broker_id",a),e.append("brokerName",t)}const r="Contado",n=$("#subtotal").val(),i=$("#ivaNac").val(),c=$("#ivaInt").val(),d=$("#total").val(),s=$("#cant_pernocta").val(),l=$("#tot_pernocta").val(),u=$("#cant_hrs").val(),p=$("#tot_hrs").val(),m=await validarGridPDF();m.length>0&&m.forEach(e=>{e.categoria&&"Ruta"!=e.categoria&&delete e.fecha_salida}),e.append("fecha_cot",a),e.append("folio",t),e.append("aeronave_id",o),e.append("condiciones",r),e.append("subtotal",n),e.append("ivaNac",i),e.append("ivaInt",c),e.append("total",d),e.append("cant_pernocta",s),e.append("tot_pernocta",l),e.append("cant_hrs",u),e.append("tot_hrs",p),e.append("detalles",JSON.stringify(m));const h=await fetch("../obtener/pdf",{method:"POST",body:e}),f=await h.json();f.urlArchivo?window.open(f.urlArchivo,"_blank"):console.error("No se pudo obtener la URL del archivo PDF.")}catch(e){console.error(e),SwalToast("warning","Error al obtener los usuarios",2500)}}async function crearCotizacion(){try{const e=new FormData,a=$("#aeronave_id").val(),t=$("#fecha-cot").val(),o=$("#estatus").val(),r=$("#rt-comment").val();if(1==$("#slctOpcion").val()){const a=$("#cliente_id").val();e.append("cliente_id",a)}else if(2==$("#slctOpcion").val()){const a=$("#broker_id").val();e.append("broker_id",a)}let n=await obtenerRutas();if(n){e.append("aeronave_id",a),e.append("fecha_creacion",t),e.append("estatus",o),e.append("comentarios",r),e.append("tipo_de_viaje",currentStep),e.append("detalleRutas",JSON.stringify(n));const i=await fetch("../crear/SolCotizacion",{method:"POST",body:e}),c=await i.json();console.log(c),1==c.exito?(SwalLoad("success","Éxito","Registro Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==c.exito&&SwalLoad("error","Error en la Transacción",c.errorSMS,!0),c.alertas&&SwalToast("warning",c.alertas.error,2500)}}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarCotizacion(){try{const e=new FormData,a=$("#cotizar_id").val(),t=$("#folio").val(),o=$("#aeronave_id").val(),r=$("#fecha-cot").val(),n=$("#estatus").val(),i=$("#tipo_cambio").val();let c="";if(1==$("#slctOpcion").val()){const a=$("#cliente_id").val();e.append("cliente_id",a)}else if(2==$("#slctOpcion").val()){const a=$("#broker_id").val();e.append("broker_id",a)}let d="";"PND"==n?(d=await obtenerRutas(),e.append("detalleRutas",JSON.stringify(d)),c=$("#rt-comment").val()):(c=$("#cot-comment").val(),d=await validarGrid());let s=await validarPasajeros();if(e.append("pasajerosDet",JSON.stringify(s)),s.forEach((a,t)=>{if(a&&a.nombre&&a.nombre_ruta){let t;a.pasajero_id?(t=a.pasajero_id,e.append("archivo_"+t,a.nombre_ruta)):(t=a.nombre.split(" ").map(e=>e.charAt(0)).join(""),e.append("archivo_"+t,a.nombre_ruta))}}),d){e.append("cotizar_id",a),e.append("folio_cotizar",t),e.append("aeronave_id",o),e.append("fecha_creacion",r),e.append("estatus",n),e.append("comentarios",c),e.append("tipo_de_viaje",currentStep),e.append("tipo_cambio_id",i);const d=await fetch("../actualizar/SolCotizacion",{method:"POST",body:e}),s=await d.json();if(console.log(s),1==s.exito)SwalLoad("success","Éxito","Registro Actualizado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500);else if(0==s.exito)return void SwalLoad("error","Error en la Transacción",s.errorSMS,!0);if(s.alertas)return void SwalToast("warning",s.alertas.error,2500)}}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function actualizarRutaPax(){try{let e=await validarRutaPax();if(""==e)return;const a=$("#cotizar_id").val(),t=document.querySelector('meta[name="csrf-token"]').getAttribute("content"),o=new FormData;o.append("id_cot",a),o.append("csrf_token",t),o.append("relRutaPax",JSON.stringify(e));const r=await fetch("../actualizar/relacionRutaPax",{method:"POST",body:o,headers:{"X-CSRF-Token":t}}),n=await r.json();console.log(n),$("#formRelRuta").empty()}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function eliminarRuta(e,a){try{const t=new FormData;t.append("cotizar_id",e),t.append("cot_det_id",a);const o=await fetch("../eliminar/ruta",{method:"POST",body:t}),r=await o.json();1==r.exito&&(SwalToast("success","Registro Eliminado Correctamente",2500),maxId-=1),r.alertas&&SwalToast("warning",r.alertas.error,2500)}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function generarServicio(){try{const e=$("#cotizar_id").val(),a=new FormData;a.append("cotizar_id",e);const t=await fetch("../generar/servicio",{method:"POST",body:a}),o=await t.json();if(1==o.exito?(SwalLoad("success","Éxito","Servicio Creado Correctamente",!1),setTimeout(()=>{swal.close(),resetForm(),obtenerCotizaciones()},1500)):0==o.exito&&SwalLoad("error","Error en la Transacción",o.errorSMS,!0),o.alertas)return void SwalToast("warning",o.alertas.error,2500)}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function obtenerCodigosIATA(e,a){try{const t=new FormData;t.append("origen",e),t.append("destino",a);const o=await fetch("../obtener/codigos",{method:"POST",body:t});return await o.json()}catch(e){console.error(e),SwalLoad("error","Ocurrio Un Error","Conección Perdida a BD.",!1)}}async function eliminarPasajero(e,a){try{const t=new FormData;t.append("cotizar_id",e),t.append("pasajero_id",a);const o=await fetch("../eliminar/pasajero",{method:"POST",body:t}),r=await o.json();if(1==r.exito&&SwalToast("success","Registro Eliminado Correctamente",2500),r.alertas)return void SwalToast("warning",r.alertas.error,2500)}catch(e){console.error(e),SwalLoad("error","Error en la Conexión","Comunicate con el Administrador",!1)}}async function validarGrid(){let e=[];try{const a=[];gridApi.forEachNode(e=>a.push(e));for(const t of a){const a=t.data.relaciones_id,o=t.data.categoria,r=t.data.concepto,n=t.data.fecha_salida,i=t.data.cantidad,c=formatearFechaYear(n);if(t.data.fecha_salida=c,t.data.categoria_nombre="",a){let a={...t.data};if(o&&(a.categoria_nombre=a.categoria.nombre),a.categoria&&void 0!==a.categoria.categoria_id&&(a.categoria=a.categoria.categoria_id),o&&"Ruta"==o.nombre){if(null==n)throw SwalToast("warning","Fecha Obligatoria",2500);if(null==i)throw SwalToast("warning","Horas Obligatorias",2500);const e=formatearFechaYear(n);a.origen&&void 0!==a.origen.aeropuerto_id&&(a.origen=a.origen.aeropuerto_id),a.destino&&void 0!==a.destino.aeropuerto_id&&(a.destino=a.destino.aeropuerto_id);const t=await formatoHora(a.hora_salida);a.hora_salida=t,a.fecha_salida=e}e.push(a)}else if(o&&"Pernocta"==o.nombre){if(null==r)throw SwalToast("warning","Concepto Obligatorio para Pernocta",2500);filaModificada={...t.data},filaModificada.categoria&&void 0!==filaModificada.categoria.categoria_id&&(filaModificada.categoria=filaModificada.categoria.categoria_id,filaModificada.categoria_nombre=o.nombre),e.push(filaModificada)}}}catch(e){return""}return e}async function validarGridPDF(){let e=[];gridApi.forEachNode(a=>{if(a.data.categoria){let t={...a.data};t.categoria=""+t.categoria.nombre,e.push(t)}});const a=(await obtenerCategorias()).map(e=>e.nombre);return e.sort((function(e,t){const o=new Date(e.fecha_salida),r=new Date(t.fecha_salida);if(o-r!=0)return o-r;const n=a.indexOf(e.categoria),i=a.indexOf(t.categoria);return n-i!=0?n-i:0!==e.concepto.localeCompare(t.concepto)?e.concepto.localeCompare(t.concepto):0!==e.destino.municipio.localeCompare(t.destino.municipio)?e.destino.municipio.localeCompare(t.destino.municipio):0!==e.origen.municipio.localeCompare(t.origen.municipio)?e.origen.municipio.localeCompare(t.origen.municipio):parseFloat(e.tarifa)-parseFloat(t.tarifa)})),e}$((function(){asignarEventos(),inicializarPagina(),configurarBotones()}));
//# sourceMappingURL=solCotizacion.js.map
